<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="generator" content="Jekyll v3.8.1">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Laon Dreams • Simple, blog-aware, static sites" />
  <link rel="alternate" type="application/atom+xml" title="Recent commits to Jekyll’s master branch" href="https://github.com/laondreams/laondreams/commits/master.atom">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic,900">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
  <link rel="stylesheet" href="/css/screen.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Android 의 Sqlite Tip | Laon Dreams • Simple, blog-aware, static sites</title>
<meta name="generator" content="Jekyll v3.8.1" />
<meta property="og:title" content="Android 의 Sqlite Tip" />
<meta name="author" content="steve" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="안드로이드에서 Sqlite 를 사용하는 소소한 팁입니다." />
<meta property="og:description" content="안드로이드에서 Sqlite 를 사용하는 소소한 팁입니다." />
<link rel="canonical" href="http://localhost:4000/news/2016/07/26/android-database-tip/" />
<meta property="og:url" content="http://localhost:4000/news/2016/07/26/android-database-tip/" />
<meta property="og:site_name" content="Laon Dreams • Simple, blog-aware, static sites" />
<meta property="og:image" content="http://localhost:4000/img/twitter-card.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-07-26T00:00:00+09:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@laondreams" />
<meta name="twitter:creator" content="@steve" />
<script type="application/ld+json">
{"url":"http://localhost:4000/news/2016/07/26/android-database-tip/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/img/LaonDreams.png"},"name":"steve"},"author":{"@type":"Person","name":"steve"},"description":"안드로이드에서 Sqlite 를 사용하는 소소한 팁입니다.","headline":"Android 의 Sqlite Tip","dateModified":"2016-07-26T00:00:00+09:00","datePublished":"2016-07-26T00:00:00+09:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/news/2016/07/26/android-database-tip/"},"image":"http://localhost:4000/img/twitter-card.png","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <!--[if lt IE 9]>
  <script src="/js/html5shiv.min.js"></script>
  <script src="/js/respond.min.js"></script>
  <![endif]-->
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-8484034453879329",
          enable_page_level_ads: true
      });
  </script>
</head>


<body class="wrap">
  <header>
  <div class="flexbox">
    <div class="center-on-mobiles">
      <h1>
        <a href="/" class="logo">
          <span class="sr-only">Jekyll</span>
          <img src="/img/LaonDreams.png" width="140" alt="LaonDreams Logo">
        </a>
      </h1>
    </div>
    <nav class="main-nav hide-on-mobiles">
      <ul>
  <li class="">
    <a href="/">Home</a>
  </li>
  <li class="">
    <a href="/docs/home/">Docs</a>
  </li>
  <li class="current">
    <a href="/news/">Posts</a>
  </li>
</ul>

    </nav>
    <div class="meta hide-on-mobiles">
    </div>
    <div class="meta hide-on-mobiles">
    </div>
    <div class="meta hide-on-mobiles">
    </div>
    <div class="meta hide-on-mobiles">
    </div>
  </div>
  <nav class="mobile-nav show-on-mobiles">
    <ul>
  <li class="">
    <a href="/">Home</a>
  </li>
  <li class="">
    <a href="/docs/home/">Docs</a>
  </li>
  <li class="current">
    <a href="/news/">Posts</a>
  </li>
</ul>

  </nav>
</header>


    <section class="news">
    <div class="grid">

      <div class="docs-nav-mobile unit whole show-on-mobiles">
  <select onchange="if (this.value) window.location.href=this.value">
    <option value="">Navigate the blog…</option>
    <option value="/news/">Home</option>
    <optgroup label="v1.x">
      
      <option value="/news/2018/05/13/android-01/">Kotlin Programming Language</option>
      
      <option value="/news/2016/12/03/gradle-tip/">Android Gradle Tips</option>
      
      <option value="/news/2016/07/26/android-database-tip/">Android 의 Sqlite Tip</option>
      
      <option value="/news/2016/04/16/migration-to-retrofit2/">Retrofit2 로 전환</option>
      
      <option value="/news/2016/02/12/Android-and-automation/">안드로이드와 자동화 툴</option>
      
      <option value="/news/2015/11/26/%EB%8D%94-%EB%B9%A0%EB%A5%B8-Andriod-App-Build/">더 빠른 Android App Build</option>
      
      <option value="/news/2015/03/10/.androidannotations-%EC%99%80-MVP/">AndroidAnnotations 와 MVP</option>
      
      <option value="/news/2015/03/01/04.androidannotation-%EA%B3%BC-%ED%85%8C%EC%8A%A4%ED%8A%B8/">AndroidAnnotations 과 테스트</option>
      
      <option value="/news/2015/03/01/03.androidannotation-%EA%B3%BC-mvc/">AndroidAnnotations 과 MVC 패턴</option>
      
      <option value="/news/2015/03/01/02.android-%EC%99%80-annotation/">Android 와 Annotation</option>
      
      <option value="/news/2015/03/01/01.Android-mvc-mvvm-mvp/">Android 와 개발 패턴</option>
      
    </optgroup>
  </select>
</div>


      <div class="unit four-fifths">
        <article>
  <h2>
    Android 의 Sqlite Tip
    <a href="/news/2016/07/26/android-database-tip/" class="header-link" title="Permalink">
      <span class="sr-only">Permalink</span>
      <i class="fa fa-link"></i>
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      26 Jul 2016
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&s=96 4x" />
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github" /> source: <a href="https://tosslab.github.io/">https://tosslab.github.io</a></p>
<h1 id="android-와-sqlite">Android 와 Sqlite</h1>

<p>Android 에서 Sqlite 는 오랫동안 사용되어 왔습니다. 지금은 Realm 과 그외의 데이터베이스들이 그 위치를 넘보고 있지만 여전히 사용되고 있음은 틀림없습니다.</p>

<p>현재 Jandi 는 서버의 대다수 정보를 앱의 Sqlite-Database 에 Cache 를 하고 있습니다. 따라서 Sqlite 를 얼마나 잘 분리하고 제어하느냐가 앱 자체의 라이프사이클에 큰 영향을 미칩니다.</p>

<p>오늘은 Android 팀이 Sqlite 를 어떻게 사용하는지 공유해드리고자 합니다.</p>

<h2 id="1-orm">1. ORM</h2>
<p>안드로이드만 하신 분들에게는 다소 생소한 개념일 수 있지만 다른 분야에서는 널리 사용되고 있습니다.</p>

<p>Android 에서 Sqlite 는 Database 용 Access 객체를 통해서 column/row 단위로 정보를 가져와서 객체를 완성합니다. 하지만 Access 객체에 일일이 Query 를 작성하는 것은 실수가 많을 뿐더러 column/row 단위 정보 매핑 작업은 매우 불편하고 지루하며 잠재적 버그를 내포한 작업니다.</p>

<p>그러기 때문에 Object-Query-Databse 를 각각에 맞게 매핑해주는 라이브러리들 통해 단순하고 반복적인 작업을 간단하게 회피할 수 있습니다.</p>

<p>아래의 블로그들이 Sqlite-Orm 라이브러리를 사용하는 좋은 정보들이 될 것입니다.
현재 Jandi-Android 의 주요 Orm 라이브러리는 OrmLite 입니다.</p>

<p><a href="http://d2.naver.com/helloworld/472196">Sqlite-Orm : 네이버 기술블로그</a></p>

<p><a href="http://greenrobot.org/android/android-orm-performance-2016/">GreenDao Benchmark</a></p>

<p><a href="https://realm.io/">Realm Database</a></p>

<h2 id="2-database-access">2. Database-Access</h2>

<h3 id="유사-관심사-domain-끼리-묶음">유사 관심사 Domain 끼리 묶음</h3>

<p>수많은 데이터를 테이블로 관리하다보면 많은 Database-Access-Object(DAO) 가 필요합니다. 하지만 자세히 들여다보면 관계된 것끼리의 묶음이 생기게 되며 이를 묶어서 하나의 Access 객체를 만들 수 있습니다.</p>

<p>Jandi 의 메시지는 크게 Text, File, Sticker 로 구분되어 있으며 이에 대한 상위로 Message 라는 개념이 있습니다. Text, File, Sticker 는 하위에 각각 2~3개의 Table 로 구성되어 있습니다.
이 전체를 각각 분리해서 관리하면 그에 따른 부수적인 제어 코드들이 불가피 하기 때문에 Jandi 에서는 최상위 Message 도메인에 맞춰서 하나의 묶음으로 관리하였습니다.</p>

<p><img src="/assets/media/post_images/message_domain.png" alt="Message Domain" /></p>

<p>코드는 다음과 같은 형태를 띄고 있습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageRepository</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="nf">getMessages</span><span class="o">(</span><span class="cm">/*args...*/</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/*코드 생략*/</span><span class="o">};</span>
  <span class="kd">public</span> <span class="n">Message</span> <span class="nf">save</span><span class="o">(</span><span class="cm">/*args...*/</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/*코드 생략*/</span><span class="o">};</span>
  <span class="kd">public</span> <span class="n">Message</span> <span class="nf">update</span><span class="o">(</span><span class="cm">/*args...*/</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/*코드 생략*/</span><span class="o">};</span>
  <span class="kd">public</span> <span class="n">Text</span> <span class="nf">getText</span><span class="o">(</span><span class="cm">/*args...*/</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/*코드 생략*/</span><span class="o">};</span>
  <span class="cm">/*이하 생략*/</span>
<span class="o">}</span>
</code></pre></div></div>

<p>이러한 형태로 독립성을 가질 수 있는 최상위 Domain 을 기준으로 Repository 클래스를 가지고 있습니다.</p>

<h2 id="3-repository-요청-관리하기">3. Repository 요청 관리하기</h2>

<p>위의 모습처럼 관심사별로 Domain 을 분리한 이유 중 가장 큰 이유는 Domain 단위로 요청을 관리하기 위함입니다.</p>

<p>Android-Sqlite 는 내부적으로 Read-Write lock 을 가지고 있지만 신뢰도가 높다 할 수 없으며 다양한 테이블에 동시 접근하는 경우 오류가 나지 않을 것이라 보장할 수 없습니다.</p>

<p>따라서 보장이 안될바에 1번에 1개의 요청만 처리 할 수 있도록 Domain 단위로 요청을 제한해버리자는 결론을 냈습니다.</p>

<p>그러기 위해 2가지 코드를 사용하였습니다.</p>

<ol>
  <li>Lock 객체 사용</li>
  <li>요청을 래핑할 template interface 사용하기</li>
</ol>

<p>멀티 쓰레드로 요청을 처리할 때 Lock 객체를 통해 1번의 1개씩의 동작만 할 수 있도록 하였으며 이를 좀 더 쉽게 쓸 수 있도록 하기 위해 Template Interface 를 만들었습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockTemplate</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">Lock</span> <span class="n">executorLock</span><span class="o">;</span>
  <span class="n">LockTemplate</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">executorLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentranceLock</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">protected</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Executable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">executorLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">executorLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">interface</span> <span class="nc">Executable</span> <span class="o">{</span>
    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">execute</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>위와 같은 클래스를 만들고 앞서 만든 Repository 클래스에 상속받도록 하였습니다.</p>

<p><img src="/assets/media/post_images/locktemplate_uml.png" alt="LockTemplate" /></p>

<p>코드는 다음과 같습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageRepository</span> <span class="kd">extends</span> <span class="n">LockTemplate</span> <span class="o">{</span>
  <span class="cm">/*싱글톤으로 동작하도록 합니다. 코드 생략*/</span>
  <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="nf">getMessages</span><span class="o">(</span><span class="kt">long</span> <span class="n">roomId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dao</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">roomId</span><span class="o">);</span>
    <span class="o">});</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">save</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dao</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
    <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>위와 같이 함으로써 최종적으로 같은 Repository 에 멀티쓰레드에서 요청을 하여도 1개의 처리만 할 수 있도록 원천적으로 작업하였습니다.</p>

<h2 id="정리">정리</h2>

<p>Android 에서 Sqlite 는 Mysql 이나 PostSQL 과 유사한 RDBMS 를 제공하는 DB 툴입니다. 하지만 기본적인 사용이 매우 번거러울 뿐만 아니라 메모리릭과 오류에 매우 쉽게 노출됩니다. 그래서 다음과 같은 방법을 통해 최소한의 안전망을 구현했습니다.</p>

<ol>
  <li>ORM 을 사용하라.
    <ul>
      <li>반복적이고 DB 접근 과정에서 오류를 최소화 시켜줍니다.</li>
    </ul>
  </li>
  <li>Lock 을 의도적으로 사용하라.
    <ul>
      <li>멀티쓰레드 접근에 의한 오류를 최소화 합니다.</li>
      <li>synchroized 보다는 concurrent 패키지에서 제공해주는 Lock 을 사용해주세요.</li>
    </ul>
  </li>
</ol>

  </div>
</article>

      </div>

      <div class="unit one-fifth hide-on-mobiles">
  <aside>
    <ul>
      <li class="">
        <a href="/news/">All Post</a>
      </li>
      <li class="">
        <a href="/news/releases/">Kotlin Releases</a>
      </li>
    </ul>
    <h4>Recent Releases</h4>
    <ul>
      
    </ul>
    <h4>Other Posts</h4>
    <ul>
        
        
        <li class="">
          <a href="/news/2018/05/13/android-01/">Kotlin Programming Language</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2016/12/03/gradle-tip/">Android Gradle Tips</a>
        </li>
        
        
        
        <li class="current">
          <a href="/news/2016/07/26/android-database-tip/">Android 의 Sqlite Tip</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2016/04/16/migration-to-retrofit2/">Retrofit2 로 전환</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2016/02/12/Android-and-automation/">안드로이드와 자동화 툴</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/11/26/%EB%8D%94-%EB%B9%A0%EB%A5%B8-Andriod-App-Build/">더 빠른 Android App Build</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/03/10/.androidannotations-%EC%99%80-MVP/">AndroidAnnotations 와 MVP</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/03/01/04.androidannotation-%EA%B3%BC-%ED%85%8C%EC%8A%A4%ED%8A%B8/">AndroidAnnotations 과 테스트</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/03/01/03.androidannotation-%EA%B3%BC-mvc/">AndroidAnnotations 과 MVC 패턴</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/03/01/02.android-%EC%99%80-annotation/">Android 와 Annotation</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/03/01/01.Android-mvc-mvvm-mvp/">Android 와 개발 패턴</a>
        </li>
        
        
    </ul>
  </aside>
</div>


      <div class="clear"></div>

    </div>
  </section>


  <footer>
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <p>
        &copy;&nbsp;2018 Laon Dreams
      <br/>Contacts: <a href="mailto:laondreams@gmail.com">laondreams@gmail.com</a></p>
    </div>
    <div class="unit two-thirds align-right center-on-mobiles">
      <p>
        Proudly hosted by
        <a href="https://github.com">
          <img src="/img/footer-logo.png" width="100" height="30" alt="GitHub • Social coding">
        </a>
      </p>
    </div>
  </div>
</footer>

  <script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = "#" + id;
    anchor.innerHTML = "<span class=\"sr-only\">Permalink</span><i class=\"fa fa-link\"></i>";
    anchor.title = "Permalink";
    return anchor;
  };

  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];

      if (typeof header.id !== "undefined" && header.id !== "") {
        header.appendChild(anchorForId(header.id));
      }
    }
  };

  document.onreadystatechange = function () {
    if (this.readyState === "complete") {
      var contentBlock = document.getElementsByClassName("docs")[0] || document.getElementsByClassName("news")[0];
      if (!contentBlock) {
        return;
      }
      for (var level = 1; level <= 6; level++) {
        linkifyAnchors(level, contentBlock);
      }
    }
  };
</script>

  
  <!-- Google Analytics (https://www.google.com/analytics) -->
  <script>
    !function(j,e,k,y,l,L){j.GoogleAnalyticsObject=y,j[y]||(j[y]=function(){
    (j[y].q=j[y].q||[]).push(arguments)}),j[y].l=+new Date,l=e.createElement(k),
    L=e.getElementsByTagName(k)[0],l.src='https://www.google-analytics.com/analytics.js',
    L.parentNode.insertBefore(l,L)}(window,document,'script','ga');

    ga('create', 'UA-119113988-1', 'auto');
    ga('send', 'pageview');

  </script>


  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
apiKey: '50fe39c839958dfad797000f33e2ec17',
indexName: 'jekyllrb',
inputSelector: '#docsearch-input',
enhancedSearchInput: true,
debug: false // Set debug to true if you want to inspect the dropdown
});
</script>

</body>
</html>
