<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="generator" content="Jekyll v3.8.1">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Laon Dreams • Simple, blog-aware, static sites" />
  <link rel="alternate" type="application/atom+xml" title="Recent commits to Jekyll’s master branch" href="https://github.com/laondreams/laondreams/commits/master.atom">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic,900">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
  <link rel="stylesheet" href="/css/screen.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>News | Laon Dreams • Simple, blog-aware, static sites</title>
<meta name="generator" content="Jekyll v3.8.1" />
<meta property="og:title" content="News" />
<meta name="author" content="all" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Dreams come true!" />
<meta property="og:description" content="Dreams come true!" />
<link rel="canonical" href="http://localhost:4000/news/" />
<meta property="og:url" content="http://localhost:4000/news/" />
<meta property="og:site_name" content="Laon Dreams • Simple, blog-aware, static sites" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@laondreams" />
<meta name="twitter:creator" content="@all" />
<script type="application/ld+json">
{"url":"http://localhost:4000/news/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/img/LaonDreams.png"},"name":"all"},"author":{"@type":"Person","name":"all"},"description":"Dreams come true!","headline":"News","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <!--[if lt IE 9]>
  <script src="/js/html5shiv.min.js"></script>
  <script src="/js/respond.min.js"></script>
  <![endif]-->
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-8484034453879329",
          enable_page_level_ads: true
      });
  </script>
</head>


<body class="wrap">
  <header>
  <div class="flexbox">
    <div class="center-on-mobiles">
      <h1>
        <a href="/" class="logo">
          <span class="sr-only">Jekyll</span>
          <img src="/img/LaonDreams.png" width="140" alt="LaonDreams Logo">
        </a>
      </h1>
    </div>
    <nav class="main-nav hide-on-mobiles">
      <ul>
  <li class="">
    <a href="/">Home</a>
  </li>
  <li class="">
    <a href="/docs/home/">Docs</a>
  </li>
  <li class="current">
    <a href="/news/">Posts</a>
  </li>
</ul>

    </nav>
    <div class="meta hide-on-mobiles">
    </div>
    <div class="meta hide-on-mobiles">
    </div>
    <div class="meta hide-on-mobiles">
    </div>
    <div class="meta hide-on-mobiles">
    </div>
  </div>
  <nav class="mobile-nav show-on-mobiles">
    <ul>
  <li class="">
    <a href="/">Home</a>
  </li>
  <li class="">
    <a href="/docs/home/">Docs</a>
  </li>
  <li class="current">
    <a href="/news/">Posts</a>
  </li>
</ul>

  </nav>
</header>


    <section class="news">
    <div class="grid">

      <div class="docs-nav-mobile unit whole show-on-mobiles">
  <select onchange="if (this.value) window.location.href=this.value">
    <option value="">Navigate the blog…</option>
    <option value="/news/">Home</option>
    <optgroup label="v1.x">
      
      <option value="/news/2018/05/13/android-01/">Kotlin Programming Language</option>
      
      <option value="/news/2016/12/03/gradle-tip/">Android Gradle Tips</option>
      
      <option value="/news/2016/07/26/android-database-tip/">Android 의 Sqlite Tip</option>
      
      <option value="/news/2016/04/16/migration-to-retrofit2/">Retrofit2 로 전환</option>
      
      <option value="/news/2016/02/12/Android-and-automation/">안드로이드와 자동화 툴</option>
      
      <option value="/news/2015/11/26/%EB%8D%94-%EB%B9%A0%EB%A5%B8-Andriod-App-Build/">더 빠른 Android App Build</option>
      
      <option value="/news/2015/03/10/.androidannotations-%EC%99%80-MVP/">AndroidAnnotations 와 MVP</option>
      
      <option value="/news/2015/03/01/04.androidannotation-%EA%B3%BC-%ED%85%8C%EC%8A%A4%ED%8A%B8/">AndroidAnnotations 과 테스트</option>
      
      <option value="/news/2015/03/01/03.androidannotation-%EA%B3%BC-mvc/">AndroidAnnotations 과 MVC 패턴</option>
      
      <option value="/news/2015/03/01/02.android-%EC%99%80-annotation/">Android 와 Annotation</option>
      
      <option value="/news/2015/03/01/01.Android-mvc-mvvm-mvp/">Android 와 개발 패턴</option>
      
    </optgroup>
  </select>
</div>


      <div class="unit four-fifths">
        
  <article>
  <h2>
    <a href="/news/2018/05/13/android-01/">
      Kotlin Programming Language
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      kotlin
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      13 May 2018
    </span>
    
    <a href="https://github.com/JetBrains" class="post-author">
      <img class="avatar avatar-small" alt="JetBrains" width="24" height="24" data-proofer-ignore="true" src="https://avatars1.githubusercontent.com/JetBrains?v=3&amp;s=24" srcset="https://avatars1.githubusercontent.com/JetBrains?v=3&amp;s=24 1x, https://avatars1.githubusercontent.com/JetBrains?v=3&amp;s=48 2x, https://avatars1.githubusercontent.com/JetBrains?v=3&amp;s=72 3x, https://avatars1.githubusercontent.com/JetBrains?v=3&amp;s=96 4x">
      JetBrains
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://github.com/JetBrains/kotlin" target="_blank">https://github.com/JetBrains/kotlin</a></p>

<p><a href="https://confluence.jetbrains.com/display/ALL/JetBrains+on+GitHub"><img src="http://jb.gg/badges/official.svg" alt="official project"></a>
<a href="http://slack.kotlinlang.org/"><img src="http://slack.kotlinlang.org/badge.svg" height="20"></a>
<a href="https://teamcity.jetbrains.com/viewType.html?buildTypeId=Kotlin_dev_Compiler&amp;branch_Kotlin_dev=%3Cdefault%3E&amp;tab=buildTypeStatusDiv"><img src="https://img.shields.io/teamcity/http/teamcity.jetbrains.com/s/Kotlin_dev_Compiler.svg" alt="TeamCity (simple build status)"></a>
<a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3A%22org.jetbrains.kotlin%22"><img src="https://img.shields.io/maven-central/v/org.jetbrains.kotlin/kotlin-maven-plugin.svg" alt="Maven Central"></a>
<a href="http://www.apache.org/licenses/LICENSE-2.0"><img src="https://img.shields.io/badge/license-Apache%20License%202.0-blue.svg?style=flat" alt="GitHub license"></a></p>

<h1 id="kotlin-programming-language">Kotlin Programming Language</h1>

<p>Welcome to <a href="https://kotlinlang.org/">Kotlin</a>! Some handy links:</p>

<ul>
  <li><a href="https://kotlinlang.org/">Kotlin Site</a></li>
  <li><a href="https://kotlinlang.org/docs/tutorials/getting-started.html">Getting Started Guide</a></li>
  <li><a href="https://try.kotlinlang.org/">Try Kotlin</a></li>
  <li><a href="https://kotlinlang.org/api/latest/jvm/stdlib/index.html">Kotlin Standard Library</a></li>
  <li><a href="https://youtrack.jetbrains.com/issues/KT">Issue Tracker</a></li>
  <li><a href="https://discuss.kotlinlang.org/">Forum</a></li>
  <li><a href="https://blog.jetbrains.com/kotlin/">Kotlin Blog</a></li>
  <li><a href="https://twitter.com/kotlin">Follow Kotlin on Twitter</a></li>
  <li><a href="http://slack.kotlinlang.org/">Public Slack channel</a></li>
  <li><a href="https://teamcity.jetbrains.com/project.html?tab=projectOverview&amp;projectId=Kotlin">TeamCity CI build</a></li>
</ul>

<h2 id="editing-kotlin">Editing Kotlin</h2>

<ul>
  <li><a href="https://kotlinlang.org/docs/tutorials/getting-started.html">Kotlin IntelliJ IDEA Plugin</a></li>
  <li><a href="https://kotlinlang.org/docs/tutorials/getting-started-eclipse.html">Kotlin Eclipse Plugin</a></li>
  <li><a href="https://github.com/vkostyukov/kotlin-sublime-package">Kotlin TextMate Bundle</a></li>
</ul>

<h2 id="build-environment-requirements">Build environment requirements</h2>

<p>In order to build Kotlin distribution you need to have:</p>

<ul>
  <li>JDK 1.6, 1.7, 1.8 and 9</li>
  <li>
    <p>Setup environment variables as following:</p>

    <div class="highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  JAVA_HOME="path to JDK 1.8"
  JDK_16="path to JDK 1.6"
  JDK_17="path to JDK 1.7"
  JDK_18="path to JDK 1.8"
  JDK_9="path to JDK 9"
</code></pre></div>    </div>
  </li>
</ul>

<p>For local development, if you’re not working on bytecode generation or the standard library, it’s OK to have only JDK 1.8 and JDK 9 installed, and to point JDK_16 and JDK_17 environment variables to your JDK 1.8 installation.</p>

<p>You also can use <a href="https://docs.gradle.org/current/userguide/build_environment.html#sec:gradle_properties_and_system_properties">Gradle properties</a> to setup JDK_* variables.</p>

<blockquote>
  <p>Note: The JDK 6 for MacOS is not available on Oracle’s site. You can <a href="https://support.apple.com/kb/DL1572">download it here</a>.</p>
</blockquote>

<h2 id="building">Building</h2>

<p>The project is built with Gradle. Run Gradle to build the project and to run the tests 
using the following command on Unix/macOS:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./gradlew &lt;tasks-and-options&gt;
</code></pre></div></div>

<p>or the following command on Windows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gradlew &lt;tasks-and-options&gt;
</code></pre></div></div>

<p>On the first project configuration gradle will download and setup the dependencies on</p>

<ul>
  <li>
<code class="highlighter-rouge">intellij-core</code> is a part of command line compiler and contains only necessary APIs.</li>
  <li>
<code class="highlighter-rouge">idea-full</code> is a full blown IntelliJ IDEA Community Edition to be used in the plugin module.</li>
</ul>

<p>These dependencies are quite large, so depending on the quality of your internet connection 
you might face timeouts getting them. In this case you can increase timeout by specifying the following 
command line parameters on the first run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./gradlew -Dhttp.socketTimeout=60000 -Dhttp.connectionTimeout=60000
</code></pre></div></div>

<h2 id="important-gradle-tasks">Important gradle tasks</h2>

<ul>
  <li>
<code class="highlighter-rouge">clean</code> - clean build results</li>
  <li>
<code class="highlighter-rouge">dist</code> - assembles the compiler distribution into <code class="highlighter-rouge">dist/kotlinc/</code> folder</li>
  <li>
<code class="highlighter-rouge">ideaPlugin</code> - assembles the Kotlin IDEA plugin distribution into <code class="highlighter-rouge">dist/artifacts/Kotlin</code> folder</li>
  <li>
<code class="highlighter-rouge">install</code> - build and install all public artifacts into local maven repository</li>
  <li>
<code class="highlighter-rouge">runIde</code> - build IDEA plugin and run IDEA with it</li>
  <li>
<code class="highlighter-rouge">coreLibsTest</code> - build and run stdlib, reflect and kotlin-test tests</li>
  <li>
<code class="highlighter-rouge">gradlePluginTest</code> - build and run gradle plugin tests</li>
  <li>
<code class="highlighter-rouge">compilerTest</code> - build and run all compiler tests</li>
  <li>
<code class="highlighter-rouge">ideaPluginTest</code> - build and run all IDEA plugin tests</li>
</ul>

<p><strong>OPTIONAL:</strong> Some artifacts, mainly Maven plugin ones, are built separately with Maven.
Refer to <a href="libraries/ReadMe.md">libraries/ReadMe.md</a> for details.</p>

<h2 id="-working-with-the-project-in-intellij-idea">
<a name="working-in-idea"></a> Working with the project in IntelliJ IDEA</h2>

<p>Working with the Kotlin project requires IntelliJ IDEA 2017.3. You can download IntelliJ IDEA 2017.3 <a href="https://www.jetbrains.com/idea/download">here</a>.</p>

<p>To import the project in Intellij choose project directory in Open project dialog. Then, after project opened, Select 
<code class="highlighter-rouge">File</code> -&gt; <code class="highlighter-rouge">New...</code> -&gt; <code class="highlighter-rouge">Module from Existing Sources</code> in the menu, and select <code class="highlighter-rouge">build.gradle.kts</code> file in the project’s root folder.</p>

<p>In the import dialog, select <code class="highlighter-rouge">use default gradle wrapper</code>.</p>

<p>To be able to run tests from IntelliJ easily, check <code class="highlighter-rouge">Delegate IDE build/run actions to Gradle</code> in the Gradle runner settings.</p>

<table>
  <tbody>
    <tr>
      <td>At this time, you can use the latest released 1.2.x version of the Kotlin plugin for working with the code. To make sure you have the latest version installed, use Tools</td>
      <td>Kotlin</td>
      <td>Configure Kotlin Plugin Updates and press “Check for updates now”.</td>
    </tr>
  </tbody>
</table>

<h3 id="compiling-and-running">Compiling and running</h3>

<p>From this root project there are Run/Debug Configurations for running IDEA or the Compiler Tests for example; so if you want to try out the latest and greatest IDEA plugin</p>

<ul>
  <li>VCS -&gt; Git -&gt; Pull</li>
  <li>Run the “IDEA” run configuration in the project</li>
  <li>a child IntelliJ IDEA with the Kotlin plugin will then startup</li>
</ul>

<h3 id="including-into-composite-build">Including into composite build</h3>

<p>To include kotlin compiler into <a href="https://docs.gradle.org/current/userguide/composite_builds.html">composite build</a> you need to define <code class="highlighter-rouge">dependencySubstitution</code> for <code class="highlighter-rouge">kotlin-compiler</code> module in <code class="highlighter-rouge">settings.gradle</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>includeBuild('/path/to/kotlin') {
    dependencySubstitution {
        substitute module('org.jetbrains.kotlin:kotlin-compiler') with project(':include:kotlin-compiler')
    }
}
</code></pre></div></div>

<h1 id="contributing">Contributing</h1>

<p>We love contributions! There’s <a href="https://youtrack.jetbrains.com/issues/KT">lots to do on Kotlin</a> and on the
<a href="https://youtrack.jetbrains.com/issues/KT?q=%23Kotlin%20%23Unresolved%20and%20(links:%20KT-2554,%20KT-4089%20or%20%23Libraries)">standard library</a> so why not chat with us
about what you’re interested in doing? Please join the #kontributors channel in <a href="http://slack.kotlinlang.org/">our Slack chat</a>
and let us know about your plans.</p>

<p>If you want to find some issues to start off with, try <a href="https://youtrack.jetbrains.com/issues/KT?q=tag:%20%7BUp%20For%20Grabs%7D%20%23Unresolved">this query</a> which should find all Kotlin issues that marked as “up-for-grabs”.</p>

<p>Currently only committers can assign issues to themselves so just add a comment if you’re starting work on it.</p>

<p>A nice gentle way to contribute would be to review the <a href="https://kotlinlang.org/api/latest/jvm/stdlib/index.html">standard library docs</a>
and find classes or functions which are not documented very well and submit a patch.</p>

<p>In particular it’d be great if all functions included a nice example of how to use it such as for the
<a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/hash-map-of.html"><code class="highlighter-rouge">hashMapOf()</code></a> function.
This is implemented using the <a href="https://github.com/JetBrains/kotlin/blob/1.1.0/libraries/stdlib/src/kotlin/collections/Maps.kt#L91"><code class="highlighter-rouge">@sample</code></a>
macro to include code from a test function. The benefits of this approach are twofold; First, the API’s documentation is improved via beneficial examples that help new users and second, the code coverage is increased.</p>

<p>Also the <a href="https://github.com/JetBrains/kotlin/blob/master/js/ReadMe.md">JavaScript translation</a> could really use your help. See the <a href="https://github.com/JetBrains/kotlin/blob/master/js/ReadMe.md">JavaScript contribution section</a> for more details.</p>

<p>Some of the code in the standard library is created by generating code from templates. See the <a href="libraries/stdlib/ReadMe.md">README</a> in the stdlib section for how to run the code generator. The existing templates can be used as examples for creating new ones.</p>

<h2 id="submitting-patches">Submitting patches</h2>

<p>The best way to submit a patch is to <a href="https://help.github.com/articles/fork-a-repo/">fork the project on github</a> then send us a
<a href="https://help.github.com/articles/creating-a-pull-request/">pull request</a> via <a href="https://github.com">github</a>.</p>

<p>If you create your own fork, it might help to enable rebase by default
when you pull by executing</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git config <span class="nt">--global</span> pull.rebase <span class="nb">true</span>
</code></pre></div></div>
<p>This will avoid your local repo having too many merge commits
which will help keep your pull request simple and easy to apply.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="/news/2016/12/03/gradle-tip/">
      Android Gradle Tips
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      03 Dec 2016
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=96 4x">
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://tosslab.github.io/">https://tosslab.github.io</a></p>
<h1 id="안드로이드와-gradle">안드로이드와 Gradle</h1>

<p>Android 가 Gradle 을 이용하기 시작한 것도 3년이 다 되어 갑니다. 이제는 많은 유저가 당연히 Gradle 을 Android 기본 개발 환경으로 사용하고 있습니다.</p>

<p>하지만 기본 설정으로만 Gradle 을 사용하는 사용자들이 많습니다. 게다가 구글에서 Android Gradle Build DSL 을 끊임없이 변경했기 때문에 많은 사용자들이 이를 이해하기도 전에 변경이 되는 경우가 매우 빈번했습니다.</p>

<blockquote>
  <ol>
    <li><a href="/android/2016/10/10/dependencies-of-gradle.html">Gradle Dependency 분리하기</a></li>
    <li><a href="/android/2016/02/12/Android-and-automation.html">안드로이드 자동화 툴</a></li>
  </ol>
</blockquote>

<p>위 두번의 포스팅을 통해서 TossLab 에서 사용하고 있는 Gradle 에 대해서 소개를 해드렸습니다.</p>

<p>오늘은 Android 팀이 사용하는 Custom 설정들에 대해서 정리하도록 하겠습니다.</p>

<h2 id="1-초기화-값-검증-및-설정하기">1. 초기화 값 검증 및 설정하기</h2>

<p>개발자들이나 CI 에서 관리해야하는 속성 값에 대해서는 각각 다르게 설정할 필요가 있습니다.</p>

<p>안드로이드 팀은 3개의 추가적인 속성값을 추가하여 사용하고 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># gradle.properties</span>
<span class="nv">inhouse_version</span><span class="o">=</span>2     <span class="c"># 배포/qa 버전의 hofix version 을 관리학 ㅣ위함</span>
<span class="nv">report_coverage</span><span class="o">=</span><span class="nb">false</span> <span class="c"># coverage 측정에 대한 on/off 기능</span>
<span class="nv">dev_min_sdk</span><span class="o">=</span>21        <span class="c"># minSDK 의 개별적인 관리를 위함</span>
</code></pre></div></div>

<p>위의 3개의 값은 존재 하지 않으면 빌드가 되지 않도록 하는 강제사항으로 만들었으나 새로운 개발자가 입사하게 되었을 때 또는 CI 서버에 실수로 기입하지 못하게 되었을 때 Project Import 나 빌드가 아예 되지 않는 현상이 발생하였기에 초기 값을 설정할 수 있도록 하였습니다.</p>

<p>report_coverage 는 <code class="highlighter-rouge">5. Android Gradle DSL</code> 에서 <code class="highlighter-rouge">buildTypes.debug.testCoverageEnabled</code> 에서 사용되며 이 값은 설정에 따라서 디버그 과정에서 변수값들이 제대로 노출되지 않게 됩니다. report 가 필요한 CI 서버 용으로 만들어진 값입니다.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// valid.gradle</span>

<span class="kt">def</span> <span class="nf">checkValidProperties</span><span class="o">()</span> <span class="o">{</span>

    <span class="n">println</span> <span class="s2">"Properties Valid Checking.........."</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">project</span><span class="o">.</span><span class="na">hasProperty</span><span class="o">(</span><span class="s2">"inhouse_version"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">println</span> <span class="s2">"set up to gradle.propeties --&gt; inhouse_version = 1 (default)"</span>
        <span class="n">project</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">inhouse_version</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">project</span><span class="o">.</span><span class="na">hasProperty</span><span class="o">(</span><span class="s2">"report_coverage"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">println</span> <span class="s2">"set up to gradle.propeties --&gt; report_coverage = false (default)"</span>
        <span class="n">project</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">report_coverage</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">project</span><span class="o">.</span><span class="na">hasProperty</span><span class="o">(</span><span class="s2">"dev_min_sdk"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">println</span> <span class="s2">"set up to gradle.propeties --&gt; dev_min_sdk = 19 (default)"</span>
        <span class="n">project</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">dev_min_sdk</span> <span class="o">=</span> <span class="mi">19</span>
    <span class="o">}</span>

    <span class="n">println</span> <span class="s2">"Properties Valid Check OK"</span>

<span class="o">}</span>

<span class="n">checkValidProperties</span><span class="o">()</span>


<span class="c1">// -------------------------------</span>
<span class="c1">// build.gradle</span>
<span class="n">apply</span> <span class="nl">from:</span> <span class="s1">'valid.gradle'</span>

</code></pre></div></div>

<p>위와 같이 설정한 뒤 <code class="highlighter-rouge">gradle.properties</code> 에 아무런 값을 설정하지 않고 빌드를 하게 되면 빌드 최초에 다음과 같은 log 를 보실 수 있습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>================================================================================
Properties Valid Checking..........
set up to gradle.propeties --&gt; inhouse_version = 1 (default)
set up to gradle.propeties --&gt; report_coverage = false (default)
set up to gradle.propeties --&gt; dev_min_sdk = 19 (default)
Properties Valid Check OK
================================================================================
</code></pre></div></div>

<h2 id="2-apk-copy-하기">2. APK Copy 하기</h2>

<p>QA 팀 전달 또는 스토어 배포시에 Android Studio 의 기본 기능을 이용하지 않고 Gradle Task 를 사용하여 빌드를 하게 되면 /app/build/outputs/apk 에 있는 패키지를 복사하는 것이 여간 귀찮은 작업이 아닐 수 없습니다.</p>

<p>그래서 Gradle 에서 기본적으로 제공되는 Copy Task 를 이용하여 APK Copy Task 를 만들었습니다.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// apk-copy.gradle</span>
<span class="n">android</span><span class="o">.</span><span class="na">applicationVariants</span><span class="o">.</span><span class="na">all</span> <span class="o">{</span> <span class="n">variant</span> <span class="o">-&gt;</span>

    <span class="c1">// 1. Copy Task 생성</span>
    <span class="kt">def</span> <span class="n">task</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">tasks</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s2">"copy${variant.name}Apk"</span><span class="o">,</span> <span class="n">Copy</span><span class="o">)</span>
    <span class="n">task</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">variant</span><span class="o">.</span><span class="na">outputs</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">outputFile</span><span class="o">)</span>

    <span class="c1">// 2. 바탕화면 Task 로 복사</span>
    <span class="n">task</span><span class="o">.</span><span class="na">into</span><span class="o">(</span><span class="s2">"${System.properties['user.home']}/Desktop/"</span><span class="o">)</span>

    <span class="c1">// 3. 복사하는 과정에서 APK 이름 변경</span>
    <span class="kt">def</span> <span class="n">targetName</span> <span class="o">=</span> <span class="s2">"jandi-${variant.baseName}-${variant.versionName}.apk"</span>
    <span class="n">task</span><span class="o">.</span><span class="na">rename</span> <span class="s2">".*"</span><span class="o">,</span> <span class="n">targetName</span>
    <span class="n">task</span><span class="o">.</span><span class="na">doFirst</span> <span class="o">{</span>
        <span class="n">println</span> <span class="s2">"copy from ${source.singleFile.name} to $destinationDir"</span>
    <span class="o">}</span>

    <span class="n">task</span><span class="o">.</span><span class="na">doLast</span> <span class="o">{</span> <span class="n">value</span> <span class="o">-&gt;</span>
        <span class="n">println</span> <span class="s2">"completed to copy : $targetName"</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="c1">// ---------------</span>
<span class="c1">// build.gradle</span>
<span class="n">apply</span> <span class="nl">from:</span> <span class="s1">'apk-copy.gradle'</span>
</code></pre></div></div>

<p>위의 Task 는 총 3개의 단계로 구분할 수 있습니다.</p>

<blockquote>
  <ol>
    <li>Copy Task 생성</li>
    <li>~/Desktop 으로 복사</li>
    <li>복사 할 때 APK 이름 변경</li>
  </ol>
</blockquote>

<p>Task 를 정의하는 과정에서 application 의 flavor, build-type, version 을 기반으로 복사하도록 한 것입니다.</p>

<p>위와 같이 설정하면 다음과 같이 사용할 수 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># flavor : qa , build-type : Debug</span>
<span class="nv">$&gt;</span> ./gradlew assembleQaDebug copyqaDebugApk
<span class="c"># 또는 줄여서 아래와 같이 쓸 수 있습니다.</span>
<span class="nv">$&gt;</span> ./gradlew aQD copyQDA
</code></pre></div></div>

<p>Application Variant 에 대한 변수는 <a href="http://tools.android.com/tech-docs/new-build-system/user-guide#TOC-Shrinking-Resources">링크</a>에서 확인하실 수 있습니다.</p>

<h2 id="3-ci-tasks">3. CI Tasks</h2>

<p>CI 용으로 CheckStyle 과 PMD 를 사용하기 때문에 관련 설정 또한 별도로 처리하였습니다.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">task</span> <span class="nf">pmd</span><span class="o">(</span><span class="nl">type:</span> <span class="n">Pmd</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">source</span> <span class="s1">'src/main'</span>
    <span class="n">include</span> <span class="s1">'**/*.java'</span>

    <span class="n">ruleSetFiles</span> <span class="o">=</span> <span class="n">files</span><span class="o">(</span><span class="s1">'../pmd.xml'</span><span class="o">)</span>
    <span class="n">ignoreFailures</span> <span class="o">=</span> <span class="kc">true</span>

<span class="o">}</span>

<span class="n">task</span> <span class="nf">checkstyles</span><span class="o">(</span><span class="nl">type:</span> <span class="n">Checkstyle</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">configFile</span> <span class="nf">file</span><span class="o">(</span><span class="s1">'../checkstyle.xml'</span><span class="o">)</span>
    <span class="n">source</span><span class="o">(</span><span class="s1">'src/main'</span><span class="o">)</span>
    <span class="n">include</span> <span class="s1">'**/*.java'</span>

    <span class="n">classpath</span> <span class="o">=</span> <span class="n">files</span><span class="o">()</span>

    <span class="n">showViolations</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="n">ignoreFailures</span> <span class="o">=</span> <span class="kc">true</span>

<span class="o">}</span>

<span class="c1">// ---------------</span>
<span class="c1">// build.gradle</span>
<span class="n">apply</span> <span class="nl">from:</span> <span class="s1">'ci-tasks.gradle'</span>
</code></pre></div></div>

<p>CheckStyle 과 PMD 설정에 필요한 정보 또한 별도의 script 로 설정하였습니다.</p>

<h2 id="4-gradle-properties">4. Gradle Properties</h2>

<p>빠른 빌드를 위해 추가적인 설정을 하고 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># gradle.properties</span>
<span class="c"># 백그라운드 빌드</span>
org.gradle.daemon<span class="o">=</span><span class="nb">true</span>
<span class="c"># 동시 빌드</span>
org.gradle.parallel<span class="o">=</span><span class="nb">true</span>
<span class="c"># jvm heap size</span>
org.gradle.jvmargs<span class="o">=</span><span class="nt">-Xmx4346m</span>
<span class="c"># build jdk</span>
org.gradle.java.home<span class="o">=</span>/Library/Java/JavaVirtualMachines/jdk1.8.0_101.jdk/Contents/Home
</code></pre></div></div>

<p>위의 설정 중에서 제일 보셔야 할 것이 <code class="highlighter-rouge">org.gradle.jvmargs</code> 입니다. Android Gradle 설정 중에서 위의 값이 적으면 빌드속도가 현저히 느려집니다.</p>

<p>빌드 할 때 console log 를 확인하시고 값을 적절하게 맞춰주실 것을 권장합니다.</p>

<h2 id="5-android-gradle-dsl-추가-정의하기">5. Android Gradle DSL 추가 정의하기</h2>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// build.gradle</span>
<span class="c1">// ...중략</span>
<span class="n">android</span> <span class="o">{</span>
  <span class="c1">// 특정 Flavor에서 Release Build 막기</span>
  <span class="n">android</span><span class="o">.</span><span class="na">variantFilter</span> <span class="o">{</span> <span class="n">variant</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">variant</span><span class="o">.</span><span class="na">buildType</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s1">'release'</span><span class="o">)</span>
              <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">variant</span><span class="o">.</span><span class="na">getFlavors</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s1">'qa'</span><span class="o">)</span>
              <span class="o">||</span> <span class="n">variant</span><span class="o">.</span><span class="na">getFlavors</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s1">'dev'</span><span class="o">)))</span> <span class="o">{</span>
          <span class="n">variant</span><span class="o">.</span><span class="na">setIgnore</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">buildTypes</span> <span class="o">{</span>
      <span class="n">debug</span> <span class="o">{</span>
          <span class="n">debuggable</span> <span class="kc">true</span>
          <span class="n">testCoverageEnabled</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">hasProperty</span><span class="o">(</span><span class="s2">"report_coverage"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">report_coverage</span><span class="o">.</span><span class="na">toBoolean</span><span class="o">()</span>
      <span class="o">}</span>
      <span class="c1">// ..중략...</span>
  <span class="o">}</span>
  <span class="n">productFlavors</span> <span class="o">{</span>
      <span class="n">dev</span> <span class="o">{</span>       <span class="c1">// demo version</span>
          <span class="n">applicationId</span> <span class="s1">'com.tosslab.jandi.app.dev'</span>
          <span class="n">versionName</span><span class="o">(</span><span class="n">defaultConfig</span><span class="o">.</span><span class="na">versionName</span> <span class="o">+</span> <span class="s2">".dev."</span> <span class="o">+</span> <span class="n">inhouse_version</span><span class="o">)</span>
          <span class="n">minSdkVersion</span> <span class="n">project</span><span class="o">.</span><span class="na">hasProperty</span><span class="o">(</span><span class="s2">"dev_min_sdk"</span><span class="o">)</span> <span class="o">?</span> <span class="n">dev_min_sdk</span> <span class="o">:</span> <span class="mi">19</span>
      <span class="o">}</span>
      <span class="c1">// ..중략..</span>
  <span class="o">}</span>

  <span class="c1">// 빌드 과정에서 CPU 와 Ram 최적화 하기</span>
  <span class="n">dexOptions</span> <span class="o">{</span>
      <span class="n">javaMaxHeapSize</span> <span class="s2">"2g"</span>
      <span class="n">maxProcessCount</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">()</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>variant-filter 를 이용해서 qa 나 dev 용 빌드는 release 버전이 빌드되지 않도록 하였습니다.</p>
  </li>
  <li>
    <p>buildTypes 와 productFlavors 에서는 앞서 설정한 gradle-properties 에 대해서 설정에 따라 기본값이 지정되도록 하였습니다.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">dexOptions</code> 설정은 개발하는 기기의 PC 환경에 따라 다를 수 있습니다.</p>
  </li>
</ul>

<p>Android DSL 에 의하면 Dex 빌드 과정에서 최종적으로 사용하는 메모리는 <code class="highlighter-rouge">heapsize * process-count</code> 라고 합니다.</p>

<blockquote>
  <ol>
    <li>heapsize 기본값 : 2048MB</li>
    <li>process-count 기본값 : 4</li>
    <li><a href="http://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.DexOptions.html#com.android.build.gradle.internal.dsl.DexOptions:maxProcessCount">참고문서</a></li>
  </ol>
</blockquote>

<h2 id="6-android-resource-image-의-exif-정보-삭제하기">6. Android Resource Image 의 EXIF 정보 삭제하기</h2>

<p>보통 디자이너가 Photoshop 과 같은 툴을 이용하여 이미지를 만들게 되면 자동으로 adobe 와 관련된 exif 정보가 붙게 됩니다. 그래서 빌드 할 때 <code class="highlighter-rouge">libpng warning : iCCP ...</code> 와 같은 warning 메세지를 보실 수 있습니다. 이는 Android Build 과정에서 <code class="highlighter-rouge">aapt</code> 가 이미지 최적화 하는 과정에서 불필요한 exif 정보로 인해서 오류를 내게 됩니다.</p>

<p>따라서 exif 정보를 초기화 해주는 작업이 필요합니다.</p>

<blockquote>
  <p>맥 사용자에 한해서 지원됩니다.</p>
</blockquote>

<p>HomeBrew 를 이용해서 exiftool 을 설치하셔야 합니다. <a href="http://brewformulas.org/Exiftool">exiftool 설명</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find <span class="nb">.</span> <span class="nt">-path</span> <span class="s1">'*src/main/res/*'</span> <span class="nt">-name</span> <span class="s1">'*.png'</span> <span class="nt">-exec</span> exiftool <span class="nt">-overwrite_original</span> <span class="nt">-all</span><span class="o">=</span> <span class="o">{}</span> <span class="se">\;</span>
</code></pre></div></div>

<p>저는 별도로 쉘 스크립트를 만들어서 실행합니다.</p>

<p>아래를 복사해서 붙여넣기로 실행하시면 됩니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"find . -path '*src/main/res/*' -name '*.png' -exec exiftool -overwrite_original -all= {} </span><span class="se">\;</span><span class="s2">"</span> <span class="o">&gt;</span> exif_clean.sh
<span class="nb">chmod </span>744 exif_clean.sh
</code></pre></div></div>

<p>관련 정보 : <a href="https://groups.google.com/forum/#!msg/adt-dev/rjTQ_STR3OE/-UcNQRISTKsJ">adt-dev google group 에서 제시된 해결책</a></p>

<h1 id="wrap-up">Wrap up</h1>

<p>안드로이드 팀은 Gradle 을 이용하여 반복적일 수 있는 작업을 자동화 하고 다양한 초기화 설정과 편의를 가지고자 하였습니다.</p>

<ol>
  <li>초기화 값 검증 및 설정</li>
  <li>Apk 복사 자동화</li>
  <li>CI Task 정의</li>
  <li>Gradle Properties 지정</li>
  <li>Android Gradle DSL 정의</li>
  <li>Android Resource Image EXIF 삭제</li>
</ol>

<p>Gradle 을 얼마나 잘 활용하냐에 따라서 조직에 필요한 Task 를 금방 만드실 수 있습니다. 이번 포스팅이 도움이 되었기를 바라며 활용해보실 것을 권장합니다.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="/news/2016/07/26/android-database-tip/">
      Android 의 Sqlite Tip
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      26 Jul 2016
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=96 4x">
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://tosslab.github.io/">https://tosslab.github.io</a></p>
<h1 id="android-와-sqlite">Android 와 Sqlite</h1>

<p>Android 에서 Sqlite 는 오랫동안 사용되어 왔습니다. 지금은 Realm 과 그외의 데이터베이스들이 그 위치를 넘보고 있지만 여전히 사용되고 있음은 틀림없습니다.</p>

<p>현재 Jandi 는 서버의 대다수 정보를 앱의 Sqlite-Database 에 Cache 를 하고 있습니다. 따라서 Sqlite 를 얼마나 잘 분리하고 제어하느냐가 앱 자체의 라이프사이클에 큰 영향을 미칩니다.</p>

<p>오늘은 Android 팀이 Sqlite 를 어떻게 사용하는지 공유해드리고자 합니다.</p>

<h2 id="1-orm">1. ORM</h2>
<p>안드로이드만 하신 분들에게는 다소 생소한 개념일 수 있지만 다른 분야에서는 널리 사용되고 있습니다.</p>

<p>Android 에서 Sqlite 는 Database 용 Access 객체를 통해서 column/row 단위로 정보를 가져와서 객체를 완성합니다. 하지만 Access 객체에 일일이 Query 를 작성하는 것은 실수가 많을 뿐더러 column/row 단위 정보 매핑 작업은 매우 불편하고 지루하며 잠재적 버그를 내포한 작업니다.</p>

<p>그러기 때문에 Object-Query-Databse 를 각각에 맞게 매핑해주는 라이브러리들 통해 단순하고 반복적인 작업을 간단하게 회피할 수 있습니다.</p>

<p>아래의 블로그들이 Sqlite-Orm 라이브러리를 사용하는 좋은 정보들이 될 것입니다.
현재 Jandi-Android 의 주요 Orm 라이브러리는 OrmLite 입니다.</p>

<p><a href="http://d2.naver.com/helloworld/472196">Sqlite-Orm : 네이버 기술블로그</a></p>

<p><a href="http://greenrobot.org/android/android-orm-performance-2016/">GreenDao Benchmark</a></p>

<p><a href="https://realm.io/">Realm Database</a></p>

<h2 id="2-database-access">2. Database-Access</h2>

<h3 id="유사-관심사-domain-끼리-묶음">유사 관심사 Domain 끼리 묶음</h3>

<p>수많은 데이터를 테이블로 관리하다보면 많은 Database-Access-Object(DAO) 가 필요합니다. 하지만 자세히 들여다보면 관계된 것끼리의 묶음이 생기게 되며 이를 묶어서 하나의 Access 객체를 만들 수 있습니다.</p>

<p>Jandi 의 메시지는 크게 Text, File, Sticker 로 구분되어 있으며 이에 대한 상위로 Message 라는 개념이 있습니다. Text, File, Sticker 는 하위에 각각 2~3개의 Table 로 구성되어 있습니다.
이 전체를 각각 분리해서 관리하면 그에 따른 부수적인 제어 코드들이 불가피 하기 때문에 Jandi 에서는 최상위 Message 도메인에 맞춰서 하나의 묶음으로 관리하였습니다.</p>

<p><img src="/assets/media/post_images/message_domain.png" alt="Message Domain"></p>

<p>코드는 다음과 같은 형태를 띄고 있습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageRepository</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="nf">getMessages</span><span class="o">(</span><span class="cm">/*args...*/</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/*코드 생략*/</span><span class="o">};</span>
  <span class="kd">public</span> <span class="n">Message</span> <span class="nf">save</span><span class="o">(</span><span class="cm">/*args...*/</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/*코드 생략*/</span><span class="o">};</span>
  <span class="kd">public</span> <span class="n">Message</span> <span class="nf">update</span><span class="o">(</span><span class="cm">/*args...*/</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/*코드 생략*/</span><span class="o">};</span>
  <span class="kd">public</span> <span class="n">Text</span> <span class="nf">getText</span><span class="o">(</span><span class="cm">/*args...*/</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/*코드 생략*/</span><span class="o">};</span>
  <span class="cm">/*이하 생략*/</span>
<span class="o">}</span>
</code></pre></div></div>

<p>이러한 형태로 독립성을 가질 수 있는 최상위 Domain 을 기준으로 Repository 클래스를 가지고 있습니다.</p>

<h2 id="3-repository-요청-관리하기">3. Repository 요청 관리하기</h2>

<p>위의 모습처럼 관심사별로 Domain 을 분리한 이유 중 가장 큰 이유는 Domain 단위로 요청을 관리하기 위함입니다.</p>

<p>Android-Sqlite 는 내부적으로 Read-Write lock 을 가지고 있지만 신뢰도가 높다 할 수 없으며 다양한 테이블에 동시 접근하는 경우 오류가 나지 않을 것이라 보장할 수 없습니다.</p>

<p>따라서 보장이 안될바에 1번에 1개의 요청만 처리 할 수 있도록 Domain 단위로 요청을 제한해버리자는 결론을 냈습니다.</p>

<p>그러기 위해 2가지 코드를 사용하였습니다.</p>

<ol>
  <li>Lock 객체 사용</li>
  <li>요청을 래핑할 template interface 사용하기</li>
</ol>

<p>멀티 쓰레드로 요청을 처리할 때 Lock 객체를 통해 1번의 1개씩의 동작만 할 수 있도록 하였으며 이를 좀 더 쉽게 쓸 수 있도록 하기 위해 Template Interface 를 만들었습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockTemplate</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">Lock</span> <span class="n">executorLock</span><span class="o">;</span>
  <span class="n">LockTemplate</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">executorLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentranceLock</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">protected</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Executable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">executorLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">executorLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">interface</span> <span class="nc">Executable</span> <span class="o">{</span>
    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">execute</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>위와 같은 클래스를 만들고 앞서 만든 Repository 클래스에 상속받도록 하였습니다.</p>

<p><img src="/assets/media/post_images/locktemplate_uml.png" alt="LockTemplate"></p>

<p>코드는 다음과 같습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageRepository</span> <span class="kd">extends</span> <span class="n">LockTemplate</span> <span class="o">{</span>
  <span class="cm">/*싱글톤으로 동작하도록 합니다. 코드 생략*/</span>
  <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="nf">getMessages</span><span class="o">(</span><span class="kt">long</span> <span class="n">roomId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dao</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">roomId</span><span class="o">);</span>
    <span class="o">});</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">save</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dao</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
    <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>위와 같이 함으로써 최종적으로 같은 Repository 에 멀티쓰레드에서 요청을 하여도 1개의 처리만 할 수 있도록 원천적으로 작업하였습니다.</p>

<h2 id="정리">정리</h2>

<p>Android 에서 Sqlite 는 Mysql 이나 PostSQL 과 유사한 RDBMS 를 제공하는 DB 툴입니다. 하지만 기본적인 사용이 매우 번거러울 뿐만 아니라 메모리릭과 오류에 매우 쉽게 노출됩니다. 그래서 다음과 같은 방법을 통해 최소한의 안전망을 구현했습니다.</p>

<ol>
  <li>ORM 을 사용하라.
    <ul>
      <li>반복적이고 DB 접근 과정에서 오류를 최소화 시켜줍니다.</li>
    </ul>
  </li>
  <li>Lock 을 의도적으로 사용하라.
    <ul>
      <li>멀티쓰레드 접근에 의한 오류를 최소화 합니다.</li>
      <li>synchroized 보다는 concurrent 패키지에서 제공해주는 Lock 을 사용해주세요.</li>
    </ul>
  </li>
</ol>

  </div>
</article>


  <article>
  <h2>
    <a href="/news/2016/04/16/migration-to-retrofit2/">
      Retrofit2 로 전환
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      16 Apr 2016
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=96 4x">
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://tosslab.github.io/">https://tosslab.github.io</a></p>

<h1 id="android-와-network">Android 와 Network</h1>

<p>Android 에서 Network 라이브러리들은 다양하지만 근 1년 사이에 주로 사용되는 라이브러리들이 점차적으로 적어지고 있습니다.</p>

<p>오늘은 그 중에서 Retrofit 에 대해 이야기 하고자 합니다.</p>

<h1 id="토스랩의-android-network-library">토스랩의 Android Network Library</h1>

<h2 id="1-spring-android-retrofit-그리고--retrofit2">1. Spring-Android, Retrofit 그리고  Retrofit2</h2>
<p>토스랩은 총 3개의 네트워크 라이브러리를 사용하였습니다. 초창기에는 AndroidAnnotations 에 연동되어 있는 Spring-Android 를 사용하였습니다. 하지만 다중 쓰레드 환경에서 동일한 Request 객체를 사용하면서 저사양 단말에서 문제로 두각되기 시작하였습니다.</p>

<p>그래서 Retrofit 으로 2015년 중순쯤 전환을 하였습니다. 그러다 2016년 초 Retrofit2 가 정식 배포가 되면서 자연스럽게 Retrofit2 로의 전환이 대두되기 시작하였습니다. 전환의 이유는 내부의 네트워크 모듈에 대한 Refactoring 이었는데 그와 동시에 Retrofit2 로의 전환도 함께 진행되었습니다.</p>

<h2 id="2-이슈들">2. 이슈들</h2>

<h3 id="what-the-call">What the CALL<t></t>
</h3>

<p>기존의 Retrofit 은 200~399 에러에 대해서는 정상적인 Body 를 반환하고 400 이상의 경우에는 Typed Exception 형태로 로직을 진행하였습니다. 하지만 이정도로는 Response Status 나  Header 정보를 알기에는 추가적인 로직이 필요로 하였습니다. 물론 Success 케이스에도 마찬가지이긴 하였습니다.</p>

<p>이는 Retrofit 의 기본적인 목적에 부합되지 않는다는 문제가 있었습니다. Retrofit 의 가장 기본적인 목적은 Okhttp 의 상위 구현체로써 쉽게 Request 와 Response 를 구현한다는 것입니다. 손쉬운 구현이 필요한 정보를 제외시킨다는 것은 별개의 문제이기 때문입니다.</p>

<p>그래서 Retrofit2 에서는 Call 객체를 통해서 Request 와 Response 에 적용된 Header, StatusCode, Body 등을 직접 접근 할 수 있도록 인터페이스를 추가하였습니다.</p>

<p>이 객체는 불변성을 가지고 있기 때문에 Getter 만이 존재하며 Request 에 필요한 정보는 다른 부분에서 적용되어야 함을 명시하셔야 합니다.</p>

<h3 id="call-객체의-적용">Call 객체의 적용</h3>

<p>Call 객체를 적용하는 과정에서 2가지의 이슈가 있었습니다.</p>

<ol>
  <li>Interface 의 모든 Return Value 를 Call<t> 로 전환할 것</t>
</li>
  <li>Request Error 를 직접 핸들링 하도록 수정해야 함</li>
</ol>

<p>이 2가지 때문에 여러가지가 연쇄적으로 수정되어야 했습니다.</p>

<p>먼저 수정과정을 설명하기 앞서 Jandi 앱의 Network 통신 전제조건에 대해서 설명해드리도록 하겠습니다.</p>

<p>Jandi 앱은 모든 Network 통신은 Current Thread 에서 한다는 것을 전제로 합니다. 이는 MainThread 에서의 통신이 아니라 호출자의 Thread 를 따라간다는 것을 전제로 하고 있습니다.
또한 이를 위해 Reponse 반환, Error Handling, 세션 자동 갱신을 위해 Generic 으로 선언된 Facade 용도의 Wrapper Class 를 별도로 두고 있습니다.</p>

<p>따라서 수정해야할 1,2 번을 위해 아래와 같은 수정을 하였습니다.</p>

<ol>
  <li>Facade Class 내에서 성공여부를 직접 파악한다.</li>
  <li>성공시 Return Value 를 직접 반환할 수 있도록 한다.</li>
  <li>실패시 Status, Response 정보를 이용하여 throw Exception 을 한다. (세션 정보를 갱신 로직은 당연히 포함되어 있습니다.)</li>
</ol>

<p>그래서 아래와 같은 코드 형태가 되었습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Response</span><span class="o">&lt;</span><span class="n">RESULT</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">apiExecutor</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">isSuccessful</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">RESULT</span> <span class="n">object</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">();</span>
    <span class="n">retryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">// 400 이상 오류에 대해 처리</span>
    <span class="k">return</span> <span class="nf">handleException</span><span class="o">(</span><span class="n">apiExecutor</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Network 통신 과정에서의 Exception 이 나는 경우는 2가지 입니다.</p>

<blockquote>
  <ol>
    <li>기기의 Network 자체가 끊겨 있거나 비정상인 경우</li>
    <li>Response 의 Parsing 과정에서 오류가 발생한 경우</li>
  </ol>
</blockquote>

<h3 id="annotation-의-변화">Annotation 의 변화</h3>

<p>Annotation 의 가장 큰 변화는 DELETE 였습니다. 기존의 Retrofit 에서는 DELETE 요청은 GET 방식으로 가능하였습니다. 즉 POST 처럼 Body 를 설정할 수 없게 되어 있었습니다. 따라서 DELETE 를 쓰기 위해서는 별도의 Custom HTTP Annotation 을 설정 할 적용하여야 했습니다.</p>

<p>Retrofit2 에서는 이런 경우에 대비하기 위해 <a href="https://github.com/HTTP" class="user-mention">@HTTP</a> 를 개방하였습니다.
<code class="highlighter-rouge">@HTTP(path = "{url}", method = "DELETE", hasBody = true)</code> 와 같이 사용해야만 Custom HTTP Method 를 적용하실 수 있습니다.</p>

<h3 id="jackson2-converter-대응">Jackson2-Converter 대응</h3>

<p>Jackson2-Converter 의 이슈는 최근에서야 알게 되었습니다. Jandi 앱은 그동안 Jackson 1.x 를 사용하였고 최근에서야 Jackson2 로 전환을 하였습니다.</p>

<p>그 과정에서 Retrofit2 의 <code class="highlighter-rouge">converter-jackson</code> 라이브러리를 사용하려 하였으나 중대한 문제가 있었습니다.</p>

<p>Retrofit2 에서 Reqeust Body 의 Serialize 는 메소드의 참조변수로 선언된 클래스만 지원하며 상속한 자녀클래스를 넣어도 부모 클래스의 결과만을 리턴 하는것이었습니다. (gson 과 여타 converter 에 대해는 해당 이슈에 대해 파악해보지 않았습니다).</p>

<p>이를테면 아래와 같은 경우입니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">Api</span> <span class="o">{</span>
  <span class="nd">@PUT</span><span class="o">(</span><span class="s">"/profile"</span><span class="o">)</span>
  <span class="n">Call</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="nf">modifyProfile</span><span class="o">(</span><span class="nd">@Body</span> <span class="n">Profile</span> <span class="n">profile</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Profile</span> <span class="o">{}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NameProfile</span> <span class="kd">extends</span> <span class="n">Profile</span><span class="o">{</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhoneProfile</span> <span class="kd">extends</span> <span class="n">Profile</span><span class="o">{</span> <span class="n">String</span> <span class="n">phone</span><span class="o">;</span> <span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// using case</span>
<span class="n">api</span><span class="o">.</span><span class="na">modifyProfile</span><span class="o">(</span><span class="k">new</span> <span class="n">NameProfile</span><span class="o">(</span><span class="s">"Steve"</span><span class="o">));</span>
</code></pre></div></div>

<p>허나 아래와 같은 상황이 펼쳐집니다.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">expect</span><span class="w">
</span><span class="p">{</span><span class="s2">"name"</span><span class="p">:</span><span class="s2">"Steve"</span><span class="p">}</span><span class="w">

</span><span class="err">//</span><span class="w"> </span><span class="err">actual</span><span class="w">
</span><span class="p">{}</span><span class="w">
</span></code></pre></div></div>

<p>해당 문제는 Converter-Jackson 의 이슈이기 때문에
위와 같은 상황이 예상된다면 별도의 Converter.Factory 를 선언하여 사용하시기 바랍니다.</p>

<h3 id="okhttpclient-생성-이슈">OkHttpClient 생성 이슈</h3>

<p>Okhttp 에 여러가지 기능이 추가되었습니다.
그중 잔디가 사용 중인 목록입니다.</p>

<ol>
  <li><a href="https://github.com/square/okhttp/tree/master/okhttp-logging-interceptor">okhttp-logging-interceptor</a></li>
  <li><a href="https://github.com/square/okhttp/wiki/Recipes#handling-authentication">authenticator</a></li>
  <li><a href="https://github.com/square/okhttp/wiki/HTTPS">Cutome SSL</a></li>
</ol>

<p>이런 이유 때문에 OkHttpClient 를 직접 생성하여 사용 하고 있습니다.</p>

<p>처음에는 OkHttpClient 를 모든 API 호출시 새로 생성하도록 하였습니다. 헌데 TestCode 가 200회가 넘어가면 File IO 를 너무 많이 사용했다는 오류가 계속적으로 발생하였습니다.</p>

<p>이 오류가 단순히 File IO 가 많아서 라는 메세지 때문에 처음에는 Database 에 대한 오류인 줄 알고 Memory Cache 작업과 테스트코드 개선작업을 하였으나 정상 동작이 되지 않았습니다.
(테스트 코드 1회에 평균 2번의 API 통신과 2회의 DB 처리를 합니다.)</p>

<p>그 와중에 기존의 테스트 코드는 정상 동작하는 것을 보고 Retrofit2 작업을 진행한 branch 만의 문제임을 깨달았습니다.</p>

<p>현재는 OkhttpClient.Builder 를 통해 생성한 1개의 OkhttpClient 만을 재사용하도록 변경하였습니다.</p>

<h3 id="network-retry-시-동작-변경">Network Retry 시 동작 변경</h3>

<p>Retrofit2 는 Call 객체를 이용하여 동일한 정보로 재요청을 할 수 있도록 지원하고 있습니다. 하지만 이에 대한 제약이 하나 있습니다. 이미 Network IO 가 끝난 경우 Retrofit2 는 Call 객체를 복사하여 재사용할 것을 가이드 하고 있습니다. 그래서 재요청시 다음과 같이 코드를 작성하셔야 합니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Call</span><span class="o">&lt;</span><span class="n">RESPONSE</span><span class="o">&gt;</span> <span class="n">call</span> <span class="o">=</span> <span class="n">action0</span><span class="o">.</span><span class="na">call</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">call</span><span class="o">.</span><span class="na">isExecuted</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">call</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">call</span><span class="o">.</span><span class="na">clone</span><span class="o">().</span><span class="na">execute</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="okhttp3-의존성">OkHttp3 의존성</h3>

<p>Okhttp 를 사용하는 타 라이브러리가 있다면 Okhttp3 의존성을 가지고 있기 때문에 이에 유념하셔야 합니다.</p>

<h2 id="3-정리">3. 정리</h2>

<p>Retrofit1 -&gt; Retrofit2 로 변경하는 과정에서 다양한 이슈를 발견하였습니다.</p>

<ol>
  <li><strong>Return Value 수정</strong></li>
  <li><strong>Exception 처리 강화</strong></li>
  <li><strong>Annotation 수정</strong></li>
  <li><strong>Request-Response Converter 수정</strong></li>
  <li><strong>OkhttpClient 재사용 정의</strong></li>
  <li><strong>재요청 처리에 대한 validation 추가</strong></li>
  <li><strong>OkHttp3 의존성</strong></li>
</ol>

<p>Retrofit2 로 변경에 있어서 가장 큰 핵심은 Call 이라는 객체라고 할 수 있다는 것입니다.</p>

<p>이 객체는 Request 에 대한 동작 제어(cancel, retry 등), Request-Response 의 독립성 보장, 그에 따라 각각의 정보에 대한 접근 등을 보장하게 됩니다.</p>

<p>Retrofit2 는 그외에도 Okhttp3 와 다양한 플러그인 지원하고 있습니다. 요청-응답에 필요한 Body 의 변환툴 (Converter-xxx), EndPoint 에서 접근하는 Call 객체에 대한 다양한 툴 (CallAdapter-xxx)</p>

<p>현재 Retrofit1 에서 잘 동작하고 있고 의도대로 흐름제어를 하고 있다면 Retrofit2 로 옮겨갈 이유는 없습니다. 하지만 변경을 하고자 한다면 이러한 영향도가 있을 것임을 공유해드렸습니다.</p>

<h3 id="참고하면-좋은-slide">참고하면 좋은 Slide</h3>

<script async="" class="speakerdeck-embed" data-id="ba44159d080a4416acb1c62353d98371" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>

<p><a href="https://speakerdeck.com/jakewharton/simple-http-with-retrofit-2-droidcon-nyc-2015">Jake Wharton’ Retrofit2</a></p>

<p><a href="https://www.youtube.com/watch?v=KIAoQbAu3eA&amp;feature=youtu.be">Presentation 영상</a></p>

  </div>
</article>


  <article>
  <h2>
    <a href="/news/2016/02/12/Android-and-automation/">
      안드로이드와 자동화 툴
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      12 Feb 2016
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=96 4x">
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://tosslab.github.io/">https://tosslab.github.io</a></p>
<h1 id="안드로이드와-자동화-툴">안드로이드와 자동화 툴</h1>

<p>모바일은 플랫폼의 생태계와 규모에 비해 개발자들이 처리해야 할 것이 매우 많습니다.</p>

<p>서버나 타 플랫폼들 또한 개발자들의 영역이 많지만 그 영역들이 세분화되고 전문화되어 가고 있습니다. 데이터베이스, 백엔드, 프론트웨어, 인프라, DevOps 와 같이 점점 분야별로 심화되고 독립성을 갖추어 가고 있습니다.</p>

<p>하지만 모바일은 각 플랫폼의 개발자들이 전체적인 아키텍쳐, 프론트, 내부용 데이터베이스, 리소스 관리, 배포 등이 해당 플랫폼의 소수의 개발자들에게 광범위하게 공존합니다. 다양한 분야가 전문화되기엔 변화가 잦고 규모가 점 형태로 구성이 된 경우가 많기 때문입니다.</p>

<p>그렇기 때문에 반복적이고 불필요하게 비용이 소모되는 작업일수록 자동화 해서 최대한 코드 작성 본연에 업무에 집중할 수 있도록 환경을 구성하는 것이 중요합니다.</p>

<p>토스랩 안드로이드 팀은 2015년 초부터 조금씩 자동화 환경을 구성하여 현재는 아래와 같습니다.</p>

<ol>
  <li>다국어 문자 관리 자동화</li>
  <li>이미지 관리 자동화</li>
  <li>CI</li>
</ol>

<h2 id="다국어-문자-리소스-자동화">다국어 문자 리소스 자동화</h2>
<p><img src="/assets/media/post_images/string_resource_script_dialog.jpg" alt="String-resource-diagram"></p>

<h3 id="1-다국어-글로벌-담당자의-원본-문서">1. 다국어 글로벌 담당자의 원본 문서</h3>
<p>토스랩은 다국어 지원을 위해 글로벌 번역 문서를 관리하고 있습니다. 문서는 Google Drive 를 통해서 관리되고 있으며 기획/개발 파트에서 다국어 지원을 위한 리소스를 기입하면 각 언어의 담당자들이 해당 언어를 번역하고 있습니다.</p>

<p>구성은 아래와 같습니다</p>

<table>
  <thead>
    <tr>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
      <th>E</th>
      <th>F</th>
      <th>G</th>
      <th>H</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>영어</td>
      <td>한국어</td>
      <td>일본어</td>
      <td>중국어-간체</td>
      <td>중국어-번체</td>
      <td>웹키</td>
      <td>ios 키</td>
      <td>안드로이드 키</td>
    </tr>
  </tbody>
</table>

<h3 id="2-기존-작업">2. 기존 작업</h3>
<p>기존에는 해당 언어의 번역 데이터를 추가하기 위해 개발 파트에서 <strong>수동으로 각 언어의 리소스 파일에 추가하는 형태</strong>로 진행하였습니다.</p>

<p>이러한 작업의 단점은 언어별 리소스 파일에 키-값 형태의 문자 리소스를 추가하는 작업을 반복적으로 해야 한다는 것입니다.
또한 반영이 된 후에 수정된 문자에 대해서 반영하기가 매우 어렵고 실수도 빈번하게 발생합니다.</p>

<p>이러한 가능성을 최소화 하기 위해 <strong>자동으로 문자 리소스를 갱신하는 작업</strong>을 진행하였습니다.</p>

<h3 id="3-안드로이드-파트를-위한-별도-필터-파일-추가">3. 안드로이드 파트를 위한 별도 필터 파일 추가</h3>
<p>|A|B|C|D|E|F|
|—-|—-|—-|—-|—-|—-|
|영어|한국어|일본어|중국어-간체|중국어-번체|안드로이드 키|</p>

<p>가급적 원본 파일에 대한 조작을 피하기 위해 <strong>안드로이드용으로 Read-Only SpreadSheet</strong> 를 별도로 생성하였습니다.</p>

<p>해당 작업을 위해 Google SpreadSheet Script 를 사용하였습니다.</p>

<h3 id="4-자동화-툴-작업">4. 자동화 툴 작업</h3>
<p>자동화 툴의 역할은 크게 3가지였습니다.</p>

<ol>
  <li>안드로이드용 필터 파일을 다운로드한다.</li>
  <li>Spread-sheet를 분석해서 다국어용 자료구조로 변환한다.</li>
  <li>다국어용 자료구조를 XML 파일로 변경한다.</li>
</ol>

<p>툴은 Python 스크립트로 작업하였습니다.</p>

<h3 id="5-gradle-task-로-추가">5. Gradle Task 로 추가</h3>

<p>별도의 Python 파일을 실행해도 되지만 Gradle Task 로 추가하여 Android Studio 에서도 Task 를 실행할 수 있도록 하였습니다.</p>

<p>개발팀에서 안드로이드 키를 원본 문서에 추가한 후 Gradle Task 실행하면 바로 반영되도록 하였습니다. 기존의 방식과 가장 큰 차이점은 <strong>Merge 시 충돌 이슈에 대해서 더이상 관여하지 않아도 된다</strong>는 것입니다. 가장 최근 시점을 기준으로 자동화 Task 를 실행하면 모든 리소스가 최신화되기 때문에 충돌이 난다하더라도 무시하고 새로 Task 를 실행함으로써 <strong>충돌에 의한 이슈를 완전히 배제하고 작업</strong>할 수 있다는 장점이 생겼습니다.</p>

<p>더 나아가 현재는 Android 용 <strong>리소스 Key를 기획 팀에서 기획시 적용</strong>하도록 하기로 현재 논의되고 있습니다. 이러한 논의가 반영된다면 더이상 리소스 관리에 있어서 개발파트에서 관리 할 필요가 없어지므로 다국어 리소스에 반영해야할 리소스 또한 최소화 될 것이라 기대하고 있습니다.</p>

<h2 id="이미지-리소스-자동화">이미지 리소스 자동화</h2>

<p><img src="/assets/media/post_images/image-resource-script-dialog.jpg" alt="image-resource-script-dialog"></p>

<h3 id="1-기존-작업">1. 기존 작업</h3>
<p>앱에 사용되는 디자인 리소스는 이슈 트래커와 JANDI 의 디자인 토픽을 통해서 전달 받아 작업을 하였습니다.</p>

<p>이런 작업 형태는 이미지 관리가 분산 될 뿐만 아니라 일관성 있는 전달 방식이 아니기 때문에 누락건이 언제든지 존재할 수 있습니다.</p>

<p>그래서 디자인 리소스에 대한 관리를 디자인 팀이 주도적으로 하며 개발팀에서는 빠르고 편하게 이미지를 전달 받을 수 있도록 하기 위해 자동화 툴을 만들었습니다.</p>

<h3 id="2-개선-작업">2. 개선 작업</h3>

<p>토스랩의 디자인 팀에서 사용하는 저장소는 권한에 따라 접근이 가능하도록 API 를 제공하고 있습니다. Read-Only 권한을 부여받은 후 API 를 통하여 이미지를 다운로드하도록 툴을 구성하였습니다.</p>

<p>툴은 Python 스크립트로 구성하였습니다.</p>

<h3 id="3-gradle-task-로-추가">3. Gradle Task 로 추가</h3>

<p>문자 리소스와 마찬가지로 별도로 Gradle 로 툴을 이용할 수 있도록 하기 위해 별도의 Task 를 정의하여 사용하도록 하였습니다.</p>

<h2 id="자동화된-리소스의-관리">자동화된 리소스의 관리</h2>

<p>문자와 이미지를 자동화로 관리한다 하더라도 개발자가 필요에 따라 임의로 추가/수정하는 리소스가 존재 할 수 있습니다.</p>

<p>이를테면 다운로드한 이미지 리소스를 활용한 Selector-Drawable 과 같은 것들입니다.</p>

<p>이에 따라 자동화 처리된 리소스들은 별도의 관리를 위해 추가적으로 ResourceSet 을 만들었습니다.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">android</span> <span class="o">{</span>
	<span class="c1">// ...중략</span>
	<span class="n">sourceSets</span> <span class="o">{</span>
		<span class="n">main</span><span class="o">.</span><span class="na">res</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">+=</span> <span class="n">$</span><span class="o">{</span><span class="err">별도의</span><span class="n">_</span><span class="err">리소스</span><span class="n">_</span><span class="err">경로</span><span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>이러한 방식을 통해서 <strong>자동화된 리소스와 추가적한 리소스를 분리</strong>하여 발생할 수 있는 문제를 최소화 하였습니다.</p>

<h2 id="지속적-통합-continuous-integration-ci">지속적 통합 (Continuous Integration, CI)</h2>

<p>자동화와 관련되어서 결코 빠질 수 없는 내용입니다.
빌드, 테스트, 배포, 리포팅에 이르기까지 이 모든 과정에 있어서 자동화 되지 않았다면 상상하기 어려운 작업들입니다.</p>

<p>토스랩에서는 Jenkins 를 활용하여 빌드-테스트-리포팅을 하고 있습니다.</p>

<h3 id="1-빌드-대상">1. 빌드 대상</h3>
<p>빌드의 의미는 최소한 컴파일 오류가 발생하지 않는 코드들이 최종 상태로 관리되고 있음을 의미합니다. 그러기 때문에 언제나 중앙 저장소에 반영되었거나 반영될 예정의 소스들은 항상 빌드 대상이라고 볼 수 있습니다.</p>

<p>안드로이드 팀은 내부적으로 빌드 대상이 되는 브랜치를 아래와 같이 정의하였습니다.</p>

<ol>
  <li>개발된 이슈가 최종적으로 반영된 브랜치 (develop)
    <ul>
      <li>Github 에서 코드에 변경이 발생하면 이를 Jenkins 로 통보하여 해당 브랜치를 빌드합니다.</li>
    </ul>
  </li>
  <li>개발 브랜치에 반영을 위해 코드리뷰 중인 브랜치 (features, fixes)
    <ul>
      <li>Github 에 새로운 Pull-Request 가 발생하면 Jenkins 로 통보하여 해당 브랜치를 빌드합니다.</li>
    </ul>
  </li>
</ol>

<p>테스트와 리포팅은 이 시점부터 발생한다고 볼 수 있습니다.</p>

<h3 id="2-빌드">2. 빌드</h3>

<p>빌드를 하는 과정에 <strong>기본적인 정적 분석</strong>을 사용하고 있습니다.
코드의 Convention 이나 복잡도 등을 측정하고 이를 분석하여 수정할 부분을 파악하기 위해서입니다.</p>

<h3 id="3-테스트">3. 테스트</h3>

<p>안드로이드팀은 작년 중순까지 Robolectric 이라는 Test Framework 을 사용하였으나 여러가지 이슈로 인하여 현재는 Android Test Support Library 를 사용하고 있습니다. ATSL 은 에뮬레이터를 필요로 하기 때문에 Jenkins 서버에 에뮬레이터를 구동하여 Test-Bed 를 구성하였습니다.</p>

<p>빌드 과정에서 정적 분석이 완료되면 테스트 코드를 동작 시킵니다.</p>

<p>테스트 된 결과는 JUnit Test Report 와 Jacoco Coverage Report 를 받고 있습니다.</p>

<h3 id="4-결과-리포트">4. 결과 리포트</h3>

<p><img src="/assets/media/post_images/jandi-webhook.jpg" alt="image-resource-script-dialog"></p>

<p>빌드, 테스트 결과는 Jenkins 에서 별도로 관리되고 있지만 모든 동작들은 자동화 되어 관리되기 때문에 별도의 장치가 없다면 알아채기 어렵습니다.</p>

<p>좀 더 빠른 피드백을 받기 위해 <strong>JANDI-Webhook</strong> 기능을 이용하여 결과 리포팅을 바로 받아 확인 할 수 있도록 하였습니다. 또한 <strong>Github Pull-Request 화면에서 Build-Status 연동</strong>하여 코드리뷰 하는 과정에서 잠재적 오류를 찾을 수 있도록 하였습니다.</p>

<p>※ 빌드된 결과물의 배포는 내부적인 정책으로 현재는 하지 않고 있습니다만, 현재 가용 가능한 리소스 안에서 해결 방안을 찾고 있습니다.</p>

<h2 id="총평">총평</h2>

<p>자동화의 가장 큰 목적은 반복적이지만 시간을 소요하기엔 가치가 떨어지는 작업을 단순화 하기 위함이었습니다. 여기서 오는 가장 큰 의미는 관리에 소요되는 시간을 최소화함으로써 생산성을 향상 시켰다는 데에 있습니다.</p>

<p>특히 다국어 리소스와 이미지 리소스를 자동화 하기 위한 작업은 소요된 시간이 극히 미미하지만 그 효과는 매우 긍정적이라 할 수 있습니다.</p>

<p>CI 는 초기 설정뿐만 아니라 관리가 매우 어려운 작업입니다. 해당 시스템을 총체적으로 알고 있다는 가정에서 해야 하며 정책적으로 규정해야 하는 것들도 있습니다. 하지만 결과물 그 자체에 대한 관리를 위해서는 없어서는 안되는 도구이며 정적분석과 자동화 테스트 등 다양한 효과를 얻을 수 있기 때문에 많은 개발자들에게 권장하고 싶습니다.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="/news/2015/11/26/%EB%8D%94-%EB%B9%A0%EB%A5%B8-Andriod-App-Build/">
      더 빠른 Android App Build
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      26 Nov 2015
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=96 4x">
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://tosslab.github.io/">https://tosslab.github.io</a></p>

<h1 id="android-app-build의-변화">Android App Build의 변화</h1>
<hr>
<p>Android App 개발에서 빌드는 올해 중순을 기점으로 큰 변화를 가져왔습니다.</p>

<p>Ant 에서 Gradle 로…
Eclipse 에서 Android Studio 로…</p>

<p>Android Studio 는 JetBrains 사의 IntelliJ 의 Community 버전을 커스터마이징한 것입니다.</p>

<p>Gradle 은  Ant 의 빌드 기능 에 Maven 의 의존성 관리 기능이 접목된 빌드 툴입니다. 그만큼 제공하는 기능이 다양하며 동시에 의존성에 대한 문제도 함께 해결이 되었습니다.</p>

<p>큰 변화는 장점과 단점 모두를 가져왔습니다. 대표적인 장점은 기존에 Eclipse 에서는 한계가 있었던 Plugin 기능이 더욱더 다양해졌다는 것입니다. 반면 갑작스럽게 바뀐 IDE 와 빌드툴은 여전히 큰 장벽으로 존재하고 있습니다.</p>

<p>특히 Gradle 의 성능 문제는 줄곧 거론되었습니다. Eclipse 에서는 빠르게 빌드되던 것이 Gradle 기반으로 전환되면서 적게는 2배에서 5배 이상 오래 소요되는 문제를 가져오게 되었습니다.</p>

<p>그러한 문제는 토스랩의 안드로이드 팀도 빗겨갈순 없었습니다.</p>

<p>코딩-빌드-실행이라는 반복적인 패턴에서 빌드에 소요되는 시간이 개발의 흐름을 끊게 되는 상황에서 이를 개선하는 것은 필수적인 요소였습니다.</p>

<p>이 포스팅은 그동안 잔디의 안드로이드 팀이 빌드 속도를 개선하기 위해 노력했던 흔적들의 모음입니다.</p>

<h1 id="new-android-app-build-system">New Android App Build System</h1>
<hr>
<h3 id="1-bazel-google">1. <a href="http://bazel.io/">Bazel</a> (Google)</h3>
<p>본디 Android 만을 위한 빌드는 아니고 iOS 까지 빌드 할 수 있는 <strong>통합 빌드 시스템</strong>이라고 보시면 됩니다. Google 의 빌드 시스템인 Blaze 에서 파생된 빌드 프로젝트로 현재 베타로 등록, 진행되고 있습니다.</p>

<h3 id="2-buck-facebook">2. <a href="https://buckbuild.com/">Buck</a> (Facebook)</h3>
<p>Bazel 보다는 좀 더 <strong>다양한 언어를 지원</strong>하기 위한 프로젝트로 보여집니다. 실제로 Go, Rust 등 다양한 언어를 지원하는 빌드 툴이라고 생각하시면 됩니다.</p>

<h3 id="3-pants-twitter-foursquare-square">3. <a href="https://pantsbuild.github.io/">Pants</a> (Twitter, FourSquare, Square)</h3>
<p>3개의 회사가 협동해서 만든 빌드 툴입니다.</p>

<ul>
  <li>특이점은 Bazel 만 Mobile Platform 을 위해 개량된 빌드 툴이고 2개는 좀 더 다양한 빌드 환경을 제공한다는 것입니다.</li>
</ul>

<h1 id="build-시스템의-성능들">Build 시스템의 성능들</h1>
<hr>
<h3 id="1-bazel">1. Bazel</h3>
<p><img src="http://bazel.io/assets/mobile-install-performance.svg" alt="Bazel Performance">|
—-|
출처 : <em><strong>Bazel</strong> (http://bazel.io/docs/mobile-install.html)</em>|</p>

<p>구글의 자료에 의하면 기존에 비해 <strong>4배~10배 의 성능 향상</strong>이 있다고 합니다.</p>

<h3 id="2-buck">2. Buck</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|**Gradle**|**Buck**|  | ----|----|----|----| clean build|31s|6s|5x| incremental build|13s|1.7s|7.5x| no-op build|3s|0.2s|15x| clean install|7.2s|7.2s|1x| incremental install|7.2s|1.5s|4.8x|
</code></pre></div></div>

<p>출처: <em><strong>Buck</strong> (https://buckbuild.com/article/exopackage.html)</em></p>

<h1 id="gradle-과-비교">Gradle 과 비교</h1>
<p>Gradle 팀에서는 Bazel 에 대해서 2015년 3월 포스팅에 아래와 같이 평하였습니다.</p>

<h3 id="gradle-팀이-꼽은-bazel-의-단점">Gradle 팀이 꼽은 Bazel 의 단점</h3>
<blockquote>
  <ol>
    <li>Bazel 은 구글의 특화 되어 있으며 쉽게 빌드 할 수 있을만큼 고수준 상태가 아니다</li>
    <li>확장성이 떨어진다.</li>
    <li>성능은 의존성이 해결된 이후의 문제이다.</li>
    <li>*nix 환경(Mac, 유닉스, 리눅스를 지칭)에서만 가능하다. 아직 많은 엔터프라이즈 툴들이 .Net 기반이다.(51%)</li>
    <li>플러그인을 위한 생태계가 구성되어 있지 않다.</li>
  </ol>
</blockquote>

<h1 id="결론">결론</h1>
<p>각각의 빌드 시스템들이 제공해주는 정보에 따르면 새로운 빌드 시스템은 큰 차이를 보여주는 빌드 환경을 제공해줍니다.
하지만 그런 이점에도 불구하고 잘 알려지지 않은 이유는 설정에 큰 어려움이 있기 때문입니다. Gradle 과 Android Plugin 에서 제공해주던 것을 직접 스크립트로 작성을 해야하며 각각의 의존성에 대해서도 직접적으로 명시를 해줘야 하기 때문에 정교하고 어려운 작업입니다. 또한 개별적으로 Plugin 을 제공하지 않아 Crash Report 를 위한 툴이나 Build 과정에서 추가적인 작업들이 필요한 경우에도 별도의 작업을 필요로 합니다.</p>

<p>이러한 어려움에 기존의 Gradle 에서 새로운 빌드 환경으로의 전환은 쉽지 않으며 끊임없는 도전이 될 것입니다.</p>

<p>그래서 잔디의 안드로이드 팀이 선택한 것은 <strong>Gradle 에서 성능 극대화 하기</strong> 입니다.</p>

<h1 id="gradle-의-성능-개선하기">Gradle 의 성능 개선하기</h1>

<h3 id="1-gradle-의-최신화">1. Gradle 의 최신화</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="err">$</span><span class="o">&gt;</span> <span class="n">vi</span> <span class="n">$project</span><span class="o">/</span><span class="n">gradle</span><span class="o">/</span><span class="n">wrapper</span><span class="o">/</span><span class="n">gradle</span><span class="o">-</span><span class="n">wrapper</span><span class="o">.</span><span class="na">properties</span>

<span class="n">distributionUrl</span><span class="o">=</span><span class="n">https</span><span class="err">\</span><span class="o">:</span><span class="c1">//services.gradle.org/distributions/gradle-2.9-all.zip</span></code></pre></figure>

<h3 id="2-android-gradle-plugin-최신화">2. Android Gradle Plugin 최신화</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">buildscrpt</span> <span class="o">{</span>
  <span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">classpath</span> <span class="err">'</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">tools</span><span class="o">.</span><span class="na">build</span><span class="o">:</span><span class="nl">gradle:</span><span class="mf">1.5</span><span class="o">.</span><span class="mi">0</span><span class="err">'</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h3 id="3-최소-지원-기기-설정하기">3. 최소 지원 기기 설정하기</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">android</span> <span class="o">{</span>
  <span class="n">productFlavors</span> <span class="o">{</span>
    <span class="n">dev</span> <span class="o">{</span>
        <span class="n">minSdkVersion</span> <span class="mi">21</span>
    <span class="o">}</span>
    <span class="n">prod</span> <span class="o">{</span>
        <span class="n">minSdkVersion</span> <span class="mi">14</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>minSdkVersion 을 LOLLIPOP 으로 설정하게 되면 Build 하는 과정에서 큰 부분이 생략이 되고 특히 MultiDex 를 설정한 프로젝트에서 더 큰 효과를 보실 수 있습니다.
Android 는 컴파일 및 패키징과정에서 Class to Dex 와 Merge Dex 을 거치게 됩니다. 이때 하지만 LOLLIPOP 부터는 art 기반이기때문에 Merge Dex 과정이 생략되기에 빌드 성능이 크게 개선됩니다.
단, API 21을 바라보기때문에 lint 나 개발 과정에서 API 특화 대응이 되질 않을 수 있습니다. 유의해서 API 를 사용해주세요.</p>

<h3 id="4-gradle-속성-추가">4. Gradle 속성 추가</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="err">$</span><span class="o">&gt;</span> <span class="n">vi</span> <span class="n">$project</span><span class="o">/</span><span class="n">gradle</span><span class="o">.</span><span class="na">properties</span>

<span class="n">org</span><span class="o">.</span><span class="na">gradle</span><span class="o">.</span><span class="na">daemon</span><span class="o">=</span><span class="kc">true</span>
<span class="n">org</span><span class="o">.</span><span class="na">gradle</span><span class="o">.</span><span class="na">parallel</span><span class="o">=</span><span class="kc">true</span>
<span class="n">org</span><span class="o">.</span><span class="na">gradle</span><span class="o">.</span><span class="na">jvmargs</span><span class="o">=-</span><span class="n">Xmx768m</span></code></pre></figure>

<h3 id="5-dexoption-추가">5. DexOption 추가</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">android</span> <span class="o">{</span>
  <span class="n">dexOptions</span> <span class="o">{</span>
    <span class="n">incremental</span> <span class="kc">true</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>※incremental 은 잠재적 오류가 있을 수 있으니 조심해서 사용하라고 합니다. <a href="http://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.DexOptions.html#com.android.build.gradle.internal.dsl.DexOptions:incremental">(참고링크)</a></p>

<h1 id="빌드-성능-비교">빌드 성능 비교</h1>
<p><strong>빌드 환경</strong> : MacBook Pro Retina 2012 (i7 2.3Ghz, 8GB Ram)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|**변경 전**|**변경 후**|  | ----|----|----|----| SingleDex clean build|57s|47s|1.2x| SingleDex incremental build|16.3s|9.6s|1.7x| MultiDex clean build|71s|71s|1x| MultiDex incremental build|48s|17.6s|2.7x|
</code></pre></div></div>

<p><strong>Incremental Build 를 보면 Single Dex, Multi Dex 모두에서 주목할만큼 성능 향상</strong>이 있습니다. 개발 과정에서는 Incremental Build 가 대다수의 빌드임을 감안한다면 Gradle 옵션을 수정이 개발 과정에서도 충분히 좋은 성능을 얻을 수 있음을 알 수 있습니다.</p>

<p>코딩-빌드-실행을 반복해야하는 패턴에서 최대한 코딩과 테스트에 집중할 수 있는 환경을 만들기 위해 했던 많은 시도들이 다른 안드로이드 개발자분들에게 큰 도움이 되었으면 합니다.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="/news/2015/03/10/.androidannotations-%EC%99%80-MVP/">
      AndroidAnnotations 와 MVP
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      10 Mar 2015
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=96 4x">
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://tosslab.github.io/">https://tosslab.github.io</a>
앞선 포스팅에서 우리는 MVC, MVP, MVVM 에 대해서 알아보았습니다.</p>

<p>그 중 MVP 는 최근에 View 와의 상호작용은 물론 모델과 뷰 분리도 효과적으로 구현할 수 있어 iOS 와 Android 모두에 적합한 모델이라는 평가를 받고 있습니다.</p>

<p>그럼 MVP 가 어떤 구조이고 실제로 코드상으로 어떻게 구현되었기에 모바일에 적합한 패턴인지 보도록 하겠습니다.</p>

<h1 id="mvp-란">MVP 란?</h1>

<p>앞선 포스팅에서 말했듯이 MVP 는 Model-Presenter-View 관계를 나타내는 패턴입니다.</p>

<p>View 는 어떠한 Presenter 와 연결될 지를 결정하여 스스로 제어될 곳을 결정합니다.
View 로부터 제어권을 할당받은 Presenter 는 Model 을 통해서 필요한 로직을 수행한 후 View 에게 다시 보여질 화면을 구현하도록 요청합니다.</p>

<p>그래서 관계도를 보면 아래와 같습니다.</p>

<p><img src="/assets/media/post_images/mvp-uml.jpg" alt="mvp-uml"></p>

<ul>
  <li>MVP 조건</li>
  <li>View : Presenter = 1:1 이어야 합니다.</li>
  <li>View 와 Presenter 는 서로 참조하고 있습니다.</li>
  <li>View 와 모델은 서로의 존재를 모릅니다.</li>
</ul>

<p>View 의 주 역할은 2가지입니다.</p>

<ol>
  <li>실제 View 에 직접 접근하여 화면을 갱신합니다.</li>
  <li>View 에서 발생하는 이벤트를 Presenter 로 전달합니다.</li>
</ol>

<p>그래서 Presenter 에는 View 에서 전달받은 이벤트 위주로 설계되기에 on…으로 시작 하는 메소드가 주로 있고
View 는 화면을 갱신해주는 기능이 주로 있어 update… set… 과 같은 메소드가 주를 이루고 있습니다.</p>

<h1 id="코드">코드</h1>

<p>그러면 AndroidAnnotations 로 구현한 MVP 코드를 살펴보도록 하겠습니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Presenter</span> <span class="o">{</span>
	<span class="kt">void</span> <span class="nf">setView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">);</span>
	<span class="kt">void</span> <span class="nf">onInfoRequest</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">View</span> <span class="o">{</span>
	<span class="kt">void</span> <span class="nf">setResultText</span><span class="o">(</span><span class="n">String</span> <span class="n">result</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@EBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PresenterImpl</span> <span class="kd">implements</span> <span class="n">Presenter</span> <span class="o">{</span>
	
	<span class="kd">private</span> <span class="n">View</span> <span class="n">view</span><span class="o">;</span>
	
	<span class="nd">@Bean</span>
	<span class="kd">private</span> <span class="n">Model</span> <span class="n">model</span><span class="o">;</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">view</span> <span class="o">=</span> <span class="n">view</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="nd">@Background</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onInfoRequest</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="na">requestInfo</span><span class="o">();</span> <span class="c1">// Network</span>
		<span class="n">view</span><span class="o">.</span><span class="na">setResultText</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@EActivity</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">act_main</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="kd">implements</span> <span class="n">View</span> <span class="o">{</span>

	<span class="nd">@Bean</span><span class="o">(</span><span class="n">PresenterImpl</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="n">Presenter</span> <span class="n">presenter</span><span class="o">;</span>
	
	<span class="nd">@ViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">txt_main</span><span class="o">)</span>
	<span class="n">TextView</span> <span class="n">resultTextView</span><span class="o">;</span>
	
	<span class="nd">@AfterInject</span>
	<span class="kt">void</span> <span class="nf">initObject</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">presenter</span><span class="o">.</span><span class="na">setView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
	<span class="o">}</span>
	
	<span class="nd">@Click</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_main</span><span class="o">)</span>
	<span class="kt">void</span> <span class="nf">onMainClick</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">presenter</span><span class="o">.</span><span class="na">onInfoRequest</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="nd">@UiThread</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setResultText</span><span class="o">(</span><span class="n">String</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">resultTextView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>MVC 와는 대조적으로 구현된 모습을 보실 수 있습니다.</p>

<p>MVC 에서는 Activity 가 Controller 역할을 수행했기 때문에 주로 <a href="https://github.com/Background" class="user-mention">@Background</a> 어노테이션 위주로 구현하였습니다.
또한 Click 과 같은 이벤트를 직접적으로 처리하도록 하였습니다.</p>

<p>반면 MVP 에서는 Activity 가 View 역할을 수행하고 있습니다.
따라서 <a href="https://github.com/UiThread" class="user-mention">@UiThread</a> 위주로 구현되어 있으며 Click 과 같은 이벤트는 직접 처리하지 않고 Presenter 로 전달하여 처리하도록 하고 있습니다. 그래서 Presenter 가 일종에 Controller 와 같은 역할을 수행하기 때문에 <a href="https://github.com/Background" class="user-mention">@Background</a> 위주로 구현되어 있습니다.</p>

<h1 id="결론">결론</h1>

<p>MVP 는 MVC 와는 대조적인 모습을 가지고 있습니다. Controller 의 기능을 Presenter 가 가지고 있지만 직접적으로 외부의 요청을 받아들이는 곳이 아닙니다. 이 과정에서 MVC 는 Controller 에서 모든 코드의 진행을 알 수 있는 반면 MVP 는 외부의 요청을 받는 곳에서 부터 코드를 쫓아가는 모습을 볼 수 있습니다.</p>

<p>하지만 이는 단점이 아니라 장점이 될 수 있습니다. 이러한 구현은 OOP 의 5대 원칙을 충실히 할 수 있습니다. 뿐만 아니라 자연스럽게 Activity ↔ Fragment 또는 Fragment 간의 통신에도 적용할 수 있습니다.</p>

<p>MVC, MVP 모두 좋은 구현 방법이며 관점에 따라서 맞춰서 사용하면 되는 것입니다. 단, 이러한 패턴을 사용할 때는 일관적인 모습으로 구현을 하여야 한다는 점을 잊어서는 안됩니다.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="/news/2015/03/01/04.androidannotation-%EA%B3%BC-%ED%85%8C%EC%8A%A4%ED%8A%B8/">
      AndroidAnnotations 과 테스트
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Mar 2015
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=96 4x">
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://tosslab.github.io/">https://tosslab.github.io</a></p>

<p>이 포스팅은 총 4부로 이어지며 현재는 4부입니다.</p>

<ol>
  <li><a href="/news/2015/03/01/01.Android-mvc-mvvm-mvp">1부 : Android, MVC, MVVM, MVP</a></li>
  <li><a href="/news/2015/03/01/02.android-%EC%99%80-annotation">2부 : Android 와 Annotation</a></li>
  <li><a href="/news/2015/03/01/03.androidannotation-%EA%B3%BC-mvc">3부 : AndroidAnnotations 과 MVC</a></li>
  <li><a href="/news/2015/03/01/04.androidannotation-%EA%B3%BC-%ED%85%8C%EC%8A%A4%ED%8A%B8">4부 : AndroidAnnotations 과 테스트</a></li>
</ol>

<p>앞선 3개의 포스팅을 통해 AndroidAnnotations 과 MVC 가
view 에 관여하는 동작들이 모두 View 로 분리된 것을 확인할 수 있습니다.</p>

<p>이러한 구조덕분에 Model 에 대한 테스트와 View 에 대한 테스트가 명확히 구분지어지게 되었습니다.</p>

<p>Test 코드를 작성함에 있어서 View 에 대한 테스트가 다소 어려움이 있다는 것을 감안한다면
Model 에 대한 테스트만 집중할 수 있는 구조가 테스트에 대한 접근을 더욱 쉽게 해줍니다.</p>

<p>다음은 앞선 포스팅에서 정의된 코드 중에서 Model 에 대한 테스트입니다.</p>

<p>※ 테스트코드는 Robolectric 을 이용하여 작성하도록 하겠습니다.</p>

<h3 id="model-test">Model Test</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">RobolectricGradleTestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainModelTest</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">MainModel</span> <span class="n">mainModel</span><span class="o">;</span>

	<span class="nd">@Setup</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">mainModel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainModel</span><span class="o">(</span><span class="n">Robolectric</span><span class="o">.</span><span class="na">application</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetReleaseState</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// given</span>
		<span class="n">String</span> <span class="n">version</span> <span class="o">=</span> <span class="s">"3.19"</span> <span class="c1">// not yet released</span>
		<span class="c1">// when</span>
		<span class="kt">boolean</span> <span class="n">isReleased</span> <span class="o">=</span> <span class="n">mainModel</span><span class="o">.</span><span class="na">getReleaseState</span><span class="o">(</span><span class="n">version</span><span class="o">);</span>
		
		<span class="c1">// then</span>
		<span class="n">assertThat</span><span class="o">(</span><span class="n">isReleased</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="n">equalTo</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
		
		<span class="c1">// given</span>
		<span class="n">version</span> <span class="o">=</span> <span class="s">"3.18"</span> <span class="c1">// released</span>
		
		<span class="c1">// when</span>
		<span class="n">isReleased</span> <span class="o">=</span> <span class="n">mainModel</span><span class="o">.</span><span class="na">getReleaseState</span><span class="o">(</span><span class="n">version</span><span class="o">);</span>
		
		<span class="c1">// then</span>
		<span class="n">assertThat</span><span class="o">(</span><span class="n">isReleased</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="n">equalTo</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
		
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>위와 같이 Model 만 별도로 테스트가 용이해졌습니다.</p>

<h3 id="presenter-test">Presenter Test</h3>

<p>Presenter 에 대한 테스트는 Model 에 대한 테스트와 다릅니다.</p>

<p>Activity 에 커플링이 높기 때문에 해당 Activity 를 직접 바인딩해야 합니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">RobolectricGradleTestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainViewTest</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">MainActivity</span> <span class="n">mainActivity</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">MainView</span> <span class="n">MainView</span><span class="o">;</span>

	<span class="nd">@Setup</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">mainActivity</span> <span class="o">=</span> <span class="n">Robolectric</span><span class="o">.</span><span class="na">buildActivity</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">create</span><span class="o">().</span><span class="na">start</span><span class="o">().</span><span class="na">resume</span><span class="o">().</span><span class="na">get</span><span class="o">();</span>
		
		<span class="n">MainView</span>  <span class="o">=</span> <span class="n">mainActivity</span><span class="o">.</span><span class="na">mainView</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetVersionText</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// given</span>
		<span class="n">String</span> <span class="n">version</span> <span class="o">=</span> <span class="s">"3.19"</span>
		
		<span class="c1">// when</span>
		<span class="n">MainView</span><span class="o">.</span><span class="na">versionEditText</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">version</span><span class="o">);</span>
		
		<span class="c1">// then</span>
		<span class="n">assertThat</span><span class="o">(</span><span class="n">MainView</span><span class="o">.</span><span class="na">getVersionText</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="n">equalTo</span><span class="o">(</span><span class="n">version</span><span class="o">));</span>
				
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>Jandi Team은 View 를 테스트하기 위해서 Presenter 와 Activity 의 패키지 Level 을 같은 Level 로 유지하고 있습니다.</p>

<p>AndroidAnnotations 에서 DI 를 설정하기 위해서는 해당 변수나 메소드는 최소 Package Scope 로 정의해야하기에 위와 같은 형태의 Field 접근을 볼 수 있습니다.</p>

<h3 id="정리">정리</h3>

<p>AndroidAnnotations 를 활용한 MVC 패턴의 전환의 또다른 이점은 이와 같이 테스트를 명확히 분리할 수 있다는 장점을 주었습니다.
물론 이 방법은 MVVM, MVP 로 구현하였을때보다 나은 형태라 할 수는 없으나
View 에 대한 테스트가 좀 더 용이해진 것이라 생각합니다.</p>

<p>※ Activity 는 왜 테스트하지 않나요?</p>

<p>MVP 패턴에서 Activity는 Controller 의 모습을 지니고 있습니다.
이는 Unit Test 가 아닌 Behavior 테스트에 가까운 모습이며
다른 방식으로의 테스트코드 구현이 필요하다고 생각합니다.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="/news/2015/03/01/03.androidannotation-%EA%B3%BC-mvc/">
      AndroidAnnotations 과 MVC 패턴
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Mar 2015
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=96 4x">
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://tosslab.github.io/">https://tosslab.github.io</a></p>

<p>이 포스팅은 총 4부로 이어지며 현재는 3부입니다.</p>

<ol>
  <li><a href="/news/2015/03/01/01.Android-mvc-mvvm-mvp">1부 : Android, MVC, MVVM, MVP</a></li>
  <li><a href="/news/2015/03/01/02.android-%EC%99%80-annotation">2부 : Android 와 Annotation</a></li>
  <li><a href="/news/2015/03/01/03.androidannotation-%EA%B3%BC-mvc">3부 : AndroidAnnotations 과 MVC</a></li>
  <li><a href="/news/2015/03/01/04.androidannotation-%EA%B3%BC-%ED%85%8C%EC%8A%A4%ED%8A%B8">4부 : AndroidAnnotations 과 테스트</a></li>
</ol>

<p>앞선 포스팅 2개를 통해서 Android 에서의 개발 패턴과 Annotation 에 대해 알아보았습니다.</p>

<p>이번에는  <a href="http://www.jandi.com">Tosslab 의 Jandi App</a> 에서 사용하는 AndroidAnnoations 와 MVC 모델을 적용하는 과정을 보여드리고자 합니다.</p>

<p>다음은 일반적인 형태의 모습을 가진 Android 코드를 MVC 로 변화하는 간단한 예시입니다.</p>

<h3 id="앱-시나리오">앱 시나리오</h3>

<p>앱 목적 : 리눅스 릴리즈 상태 확인하기</p>

<p>EditText 에 리눅스 버전을 입력하면
Github 에 접근 하여 릴리즈 정보가 있는지 확인합니다.</p>

<p>릴리즈 정보가 있으면 release 로 표시
릴리즈 정보가 없으면 not release 로 표시</p>

<p>※ http 통신은 pseudo 코드로 표현하도록 하겠습니다.</p>

<h3 id="기존-코드">기존 코드</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">EditText</span> <span class="n">versionEdtiText</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Button</span> <span class="n">checkButton</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">TextView</span> <span class="n">releaseText</span><span class="o">;</span>
	
	<span class="kd">private</span> <span class="n">Handler</span> <span class="n">handler</span><span class="o">;</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">saveInstance</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">saveInstance</span><span class="o">);</span>
		<span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">act_main</span><span class="o">);</span>
		
		<span class="n">versionEdtiText</span> <span class="o">=</span> <span class="o">(</span><span class="n">EditText</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">et_version</span><span class="o">);</span>
		<span class="n">checkButton</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_check</span><span class="o">);</span>
		<span class="n">releaseText</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tv_release</span><span class="o">);</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">();</span>
		
		<span class="n">checkButton</span><span class="o">.</span><span class="na">setOnClick</span><span class="o">(</span><span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClick</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">String</span> <span class="n">version</span> <span class="o">=</span> <span class="n">versionEditText</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">;</span>
				
				<span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">VersionCheckRunnable</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">version</span><span class="o">,</span> <span class="k">new</span> <span class="n">Callback</span><span class="o">(){</span>
				<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCheckResult</span><span class="o">(</span><span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isRelease</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">handler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">(){</span>
						<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">isRelease</span><span class="o">)</span> <span class="o">{</span>
								<span class="n">releaseText</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"release);
							} else {
								releaseText.setText("</span><span class="n">not</span> <span class="n">release</span><span class="o">);</span>
							<span class="o">}</span>
						<span class="o">}</span>
					<span class="o">});</span>
				<span class="o">}</span>
				<span class="o">})).</span><span class="na">start</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">});</span>
	<span class="o">}</span>
	
	<span class="kd">static</span> <span class="kd">class</span> <span class="nc">VersionCheckRunnable</span> <span class="n">implement</span> <span class="n">Runnable</span> <span class="o">{</span>

		<span class="kd">private</span> <span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">;</span>
		<span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">version</span><span class="o">;</span>		
		<span class="kd">private</span> <span class="kd">final</span> <span class="n">Callback</span> <span class="n">callback</span><span class="o">;</span>
		
		<span class="kd">public</span> <span class="nf">VersionCheckRunnable</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">version</span><span class="o">,</span> <span class="n">Callback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">version</span> <span class="o">=</span> <span class="n">version</span><span class="o">;</span>
			<span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
			<span class="k">this</span><span class="o">.</span><span class="na">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="o">;</span>
		<span class="o">}</span>
		
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
			<span class="kt">boolean</span> <span class="n">isReleased</span> <span class="o">=</span> <span class="n">getReleaseState</span><span class="o">(</span><span class="n">version</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">callback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">callback</span><span class="o">.</span><span class="na">onCheckResult</span><span class="o">(</span><span class="n">isReleased</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		
		<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">getReleaseState</span><span class="o">(</span><span class="n">String</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// ... 중략</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Callback</span> <span class="o">{</span>
		<span class="kt">void</span> <span class="nf">onCheckResult</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">isReleased</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>위의 사례는 조금 극단적인 안드로이드 개발 코드입니다. MVC 조차로도 구현되어 있지 않은 코드 상태입니다.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">사용자가 버젼을 입력 -&gt; 버튼 누르기</td>
    </tr>
  </tbody>
</table>

<p>위의 동작을 수행하면</p>

<p>새로운 Thread 를 생성하여 서버와 통신을 시작합니다.
통신이 완료되면 Handler 에게 결과를 전송하여 UI 갱신을 하도록 합니다.</p>

<p>멀티쓰레딩 처리, View 바인딩, UI 처리가 혼합되어 있어 코드에 대한 가독성이 극단적으로 좋지 않은 형태입니다.
만약 이러한 처리가 하나의 Activity 에서 다양하게 존재한다면 유지보수성은 최악이 될 가능성이 농후해집니다.</p>

<p>이를 아래에서 AndroidAnnotations 을 이용하여 MVC 패턴으로 적용해보도록 하겠습니다.</p>

<h3 id="mvc-로-적용된-모습">MVC 로 적용된 모습</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@EActivity</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">act_main</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

	<span class="nd">@Bean</span>
	<span class="n">MainView</span> <span class="n">MainView</span><span class="o">;</span>
	
	<span class="nd">@Bean</span>
	<span class="n">MainModel</span> <span class="n">mainModel</span><span class="o">;</span>

	<span class="nd">@Click</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_check</span><span class="o">)</span>
	<span class="nd">@Background</span>
	<span class="kt">void</span> <span class="nf">onCheckClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">versionText</span> <span class="o">=</span> <span class="n">MainView</span><span class="o">.</span><span class="na">getVersionText</span><span class="o">();</span>
		
		<span class="kt">boolean</span> <span class="n">isRelease</span> <span class="o">=</span> <span class="n">mainModel</span><span class="o">.</span><span class="na">getReleaseState</span><span class="o">(</span><span class="n">version</span><span class="o">);</span>
		
		<span class="k">if</span> <span class="o">(</span><span class="n">isRelease</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">MainView</span><span class="o">.</span><span class="na">setReleaseText</span><span class="o">(</span><span class="s">"release"</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">MainView</span><span class="o">.</span><span class="na">setReleaseText</span><span class="o">(</span><span class="s">"not release"</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@EBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainView</span> <span class="o">{</span>

	<span class="nd">@ViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">et_version</span><span class="o">)</span>
	<span class="n">EditText</span> <span class="n">versionEditText</span><span class="o">;</span>
	
	<span class="nd">@ViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tv_release</span><span class="o">)</span>
	<span class="n">TextView</span> <span class="n">releaseText</span><span class="o">;</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getVersionText</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">versionEditText</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="nd">@UiThread</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setReleaseText</span><span class="o">(</span><span class="n">String</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">releaseText</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">version</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@EBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainModel</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">getReleaseState</span><span class="o">(</span><span class="n">String</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// ...중략...</span>
		<span class="c1">// 기존 VersionCheckRunnable 의 코드를 그대로 가져온다.</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>Model 은 서버와 통신을 수행하고 ViewController 는 View 에 직접 접근하도록 정의하였습니다.
Activity 는 Controller 의 역할을 위해 Model 과 ViewController 에 대한 정보와 View Event 만을 정의하였습니다.</p>

<p>여기서 눈여겨볼 점은  다음 코드입니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

	<span class="nd">@Click</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_check</span><span class="o">)</span>
	<span class="nd">@Background</span>
	<span class="kt">void</span> <span class="nf">onCheckClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{...}</span>

<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainView</span> <span class="o">{</span>
	<span class="nd">@UiThread</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setReleaseText</span><span class="o">(</span><span class="n">String</span> <span class="n">version</span><span class="o">)</span> <span class="o">{...}</span>
<span class="o">}</span></code></pre></figure>

<ol>
  <li>버튼의 Click 이벤트정의를 <a href="https://github.com/Click" class="user-mention">@Click</a>({Resource ID}) 만으로 정의하였다는 점</li>
  <li>MultiThread 처리를 <a href="https://github.com/Background" class="user-mention">@Background</a> 로 정의한 점</li>
  <li>MainThread 처리 <a href="https://github.com/UiThread" class="user-mention">@UiThread</a> 로 정의한 점</li>
</ol>

<p>AndroidAnnotations 으로 정의된 클래스를 APT 로 컴파일한 후 클래스를 보면</p>

<ol>
  <li>View.setOnClickListener 가 직접 정의된 모습</li>
  <li>MultiThread 처리는 AndroidAnnotations 내부에서 정의된 ThreadPool 에서 실행시키는 모습</li>
</ol>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity_</span> <span class="kd">extends</span> <span class="n">MainActivity</span> <span class="o">{</span>
	<span class="c1">// ...중략...</span>
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init_</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">View</span> <span class="n">hasView</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_check</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">hasView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">hasView</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
				<span class="nd">@Override</span>
				<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="kd">final</span> <span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">BackgroundExecutor</span><span class="o">..</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">BackgroundExecutor</span><span class="o">.</span><span class="na">Task</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="s">""</span><span class="o">)</span> <span class="o">{</span>

		            <span class="nd">@Override</span>
		            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>
		                <span class="k">try</span> <span class="o">{</span>
		                    <span class="n">MainActivity_</span><span class="o">.</span> <span class="nf">onCheckClick</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
		                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		                    <span class="n">Thread</span><span class="o">.</span><span class="na">getDefaultUncaughtExceptionHandler</span><span class="o">().</span><span class="na">uncaughtException</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
		                <span class="o">}</span>
		            <span class="o">}</span>
				<span class="o">}</span>
			<span class="o">});</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<ol>
  <li>MainThread 처리는 Handler.post(new Runnable(){…}) 을 이용한 모습</li>
</ol>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainView_</span> <span class="kd">extends</span> <span class="n">MainView</span> <span class="o">{</span>

	<span class="n">Handler</span> <span class="n">handler_</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">MainView_</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">handler_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setReleaseText</span><span class="o">(</span><span class="n">String</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">handler_post</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">MainView</span><span class="o">.</span><span class="na">super</span><span class="o">.</span><span class="na">setReleaseText</span><span class="o">(</span><span class="n">version</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">});</span>
	<span class="o">}</span></code></pre></figure>

<p>위와 같은 모습을 확인할 수 있습니다.</p>

<p>결과적으로 우리가 작성하는 코드들은 최대한 적은 Depth 로 구현하고 실질적인 동작은 AndroidAnnotations 을 통해서 정의됨을 볼 수 있습니다.</p>

<p>이로써 MVC 단점인 View 와 Event 에 대한 바인딩이 콜백에 의해 정의되는 것을 최소화 하면서 Model-View 가 분리되고 Activity 가 Controller 의 역할을 수행하는 것을 알 수 있습니다.</p>

<h3 id="mvc-를-구현하기-위한-노하우">MVC 를 구현하기 위한 노하우</h3>

<ul>
  <li>MVC 의 Activity 는 View? Controller!</li>
</ul>

<p>Activity 의 역할이 가장 중요하다 View 의 성격도 같이 가지고 있는 Activity 에서 view 처리는 모두 View 에서 처리하도록 합니다.
그리고 Activity 는 View 나 외부에서 들어오는 이벤트 등을 받아서 Model - View 사이에서 로직을 제어하는 역할만 합니다.</p>

<ul>
  <li>Callback 코드의 최소화</li>
</ul>

<p>안드로이드 코드들은 View 에 대한 이벤트 정의를 Callback 형태로 정의합니다. 하지만 이러한 코드 형태는 Background 와 Main Thread 를 오가는 환경이 생긴다면 Callback Hell 이라고 부르는 지경에 이르게 됩니다.</p>

<p>하지만 예제에서는 View 이벤트는 ViewController 에서 직접적으로 받을 수 있도록 하되 View 에 접근하는 코드를 최소화 하기 위해서 Event 에 대해서는 Annotation 을 통해 코드 가독성이 떨어지는 Callback 을 최소화 하는 구조를 변경하였습니다.</p>

<p>간혹 Dialog 와 같이 직접적인 접근이 어려운 곳은 EventBus 와 같은 Observer 를 통해서 처리할 수 있도록 하여 가능한 구조의 일관성을 가지고자 합니다.</p>

<ul>
  <li>Background 로직이 필요하는 경우</li>
</ul>

<p>AndroidAnnotations 은 <a href="https://github.com/Background" class="user-mention">@Background</a> 가 선언된 메소드는 Background 에서 동작하도록 제어합니다. 별도로 Thread 를 선언할 필요가 없으며 다시 Ui Thread 에 접근하고자 할 때는 <a href="https://github.com/UiThread" class="user-mention">@UiThread</a> 를 통해 접근할 수 있습니다.</p>

<p>또한 <a href="https://github.com/SupposedBackground" class="user-mention">@SupposedBackground</a> 와 <a href="https://github.com/SupposedUiThread" class="user-mention">@SupposedUiThread</a> 를 통해서 현재 메소드가 원하는 Thread 에서 접근하는 것인지 Assertion 을 지원합니다. 위의 Annotation 은 Runtime 동작하여 Runtime 오류 가능성이 있습니다.</p>

<p><a href="https://github.com/Background" class="user-mention">@Background</a> -&gt; <a href="https://github.com/UiThread" class="user-mention">@UiThread</a> 접근시 유의점
<a href="https://github.com/UiThread" class="user-mention">@UiThread</a> 가 선언된 코드는 내부 동작이 Handler.post(…) 를 통해서 실행됩니다. 따라서 <a href="https://github.com/UiThread" class="user-mention">@UiThread</a> 를 연속으로 실행한다고 해서 동작의 순서가 보장되지 않습니다. 가급적 연관된 동작은 하나의 <a href="https://github.com/UiThread" class="user-mention">@UiThread</a> 에 정의를 해주는 것이 좋습니다.</p>

<ul>
  <li>DI 기능 적극 활용</li>
</ul>

<p>Reflection 에 의한 View DI 는 필연적으로 Runtime 시 성능에 영향이 가는 동작방식입니다.</p>

<p>하지만 Android-Annotation 의 DI 는 Annotation Procession Tool (APT) 를 이용하여 동작하기 때문에 생성된 코드에 “_” 가 붙는 단점이 있긴 하나 DI 과정에서 성능상 영향을 거의 주지 않습니다.</p>

<p>※ View DI 용도만을 위함이라면 Dagger 나 ButterKnife 도 좋은 해결책입니다. 두 라이브러리 모두 APT 를 사용하여 View DI를 합니다.</p>

<h3 id="결론">결론</h3>

<p>처음 AndroidAnnotations 을 접했을 때는 생성된 코드에 “_” 를 붙여야만 접근할 수 있는 좋지 않는 형태를 가지고 있었습니다.</p>

<p>하지만 이러한 단점을 제외한다면 구조적으로 MVP 모델에 매우 적합한 모습을 유지할 수 있는 코드를 만들어주는 장점을 가졌습니다.</p>

<p>경험적으로 MVC, MVVM, MVP 를 모두 구현하고자 했을 때 AndroidAnnotations 은 MVC 가 가지고 있는 Controller - View 간의 이벤트 Callback 처리에 대한 단점 또한 유연하게 대처할 수 있도록 해주었습니다. (<a href="https://github.com/Click" class="user-mention">@Click</a> 과 같은 이벤트 Annotation 으로…)</p>

<p>현재 Jandi 팀은  AndroidAnnotations 과 MVC 모델을 적극적으로 도입하여 사용하고 있으며 UnitTest 작성에도 View 와 Model 이 분리하여 작성할 수 있었습니다.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="/news/2015/03/01/02.android-%EC%99%80-annotation/">
      Android 와 Annotation
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Mar 2015
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=96 4x">
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://tosslab.github.io/">https://tosslab.github.io</a></p>

<p>이 포스팅은 총 4부로 이어지며 현재는 2부입니다.</p>

<ol>
  <li><a href="/news/2015/03/01/01.Android-mvc-mvvm-mvp">1부 : Android, MVC, MVVM, MVP</a></li>
  <li><a href="/news/2015/03/01/02.android-%EC%99%80-annotation">2부 : Android 와 Annotation</a></li>
  <li><a href="/news/2015/03/01/03.androidannotation-%EA%B3%BC-mvc">3부 : AndroidAnnotations 과 MVC</a></li>
  <li><a href="/news/2015/03/01/04.androidannotation-%EA%B3%BC-%ED%85%8C%EC%8A%A4%ED%8A%B8">4부 : AndroidAnnotations 과 테스트</a></li>
</ol>

<h3 id="annotation-이란">Annotation 이란?</h3>

<blockquote>
  <p>사전적 의미 : 주석</p>
</blockquote>

<ul>
  <li>특정 클래스, 변수,메소드 등에 붙이는 코드로 해당 타겟의 기능을 좀 더 명확하게 해주는 역할을 합니다. Web Spring 프레임워크 등에서는 타겟의 기능을 정의하여 특정 역할을 수행할 수 있도록 사용되고 있습니다.</li>
</ul>

<p>Java 에서 Annotation 이 동작하는 방식은 크게 2가지 입니다.</p>

<ol>
  <li>java.lang.reflection 을 이용해서 Class 정보를 읽어 Instance 의 타겟에 Annotation 에 해당되는 기능을 정의하는 방식</li>
  <li>Annotation Processing Tool(APT) 을 이용하여 Compile 단계에서 Annotation 이 정의된 타겟의 정보를 미리 정의하는 방식</li>
</ol>

<p>위의 2가지 방식 중에서는 2의 방식이 성능면에서 좋은 방식입니다. 하지만 APT 에 의한 방식은 Compile 된 클래스가 A.class -&gt; A_.class 라는 식으로 “_” 가 붙는 단점이 있습니다.</p>

<h3 id="java-annotation-접근">Java Annotation 접근</h3>

<ul>
  <li>java.lang.reflection 을 이용한 동작</li>
</ul>

<p>다음 코드는 java.lang.reflection 을 통해서 특정 타겟에 접근하여 객체에 Annotation 에 맞게 정의하는 방식입니다.
(View 의 DI 를 위한 동작입니다.)</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ResourceView</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="nf">id</span><span class="o">()</span> <span class="k">default</span> <span class="mi">0</span><span class="o">;</span>

<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectController</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">injectLayout</span><span class="o">(</span><span class="n">Activity</span> <span class="n">mActivity</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="o">;</span>
        <span class="n">AbstractInjectCommand</span> <span class="n">command</span><span class="o">;</span>

        <span class="n">ResourceLayout</span> <span class="n">mLayoutAnnotation</span> <span class="o">=</span> <span class="n">mActivity</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">ResourceLayout</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">InjectFactory</span><span class="o">.</span><span class="na">createInjectCommand</span><span class="o">(</span><span class="n">mActivity</span><span class="o">,</span> <span class="n">mLayoutAnnotation</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">command</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">command</span><span class="o">.</span><span class="na">excute</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// 어노테이션이 선언된 타겟에 접근하기 위해 클래스 변수에 접근</span>
        <span class="n">Field</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">mActivity</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredFields</span><span class="o">();</span>

        <span class="kt">int</span> <span class="n">fieldSize</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">annoSize</span><span class="o">;</span>
        <span class="n">Field</span> <span class="n">field</span><span class="o">;</span>


        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">fieldIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">fieldIdx</span> <span class="o">&lt;</span> <span class="n">fieldSize</span><span class="o">;</span> <span class="o">++</span><span class="n">fieldIdx</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="o">[</span><span class="n">fieldIdx</span><span class="o">];</span>

            <span class="c1">// private 변수에 접근하기 위함</span>
            <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

            <span class="c1">// 어노테이션 접근</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="na">getDeclaredAnnotations</span><span class="o">();</span>

            <span class="n">annoSize</span> <span class="o">=</span> <span class="n">annotations</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">annoIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">annoIdx</span> <span class="o">&lt;</span> <span class="n">annoSize</span><span class="o">;</span> <span class="o">++</span><span class="n">annoIdx</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 어노테이션별 동작 수행</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">InjectFactory</span><span class="o">.</span><span class="na">createInjectCommand</span><span class="o">(</span><span class="n">mActivity</span><span class="o">,</span> <span class="n">annotations</span><span class="o">[</span><span class="n">annoIdx</span><span class="o">]);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">command</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">command</span><span class="o">.</span><span class="na">excute</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Annotation 이 정의된 타겟을 Java Reflection 을 이용해서 접근한 뒤 Annotation 정보를 추출 후 Annotation 에 맞게 동작을 합니다.
위의 소스는 View 를 Binding 하는 과정 중 일부입니다.</p>

<p><br></p>

<ul>
  <li>Annotation Processing Tool(APT) 에 의한 동작</li>
</ul>

<p>이와 다르게 APT 를 이용한 방식은 Compile 단계에서 미리 Annotation 이 정의 되기 때문에
Compile 되는 순서를 도식화 하였습니다.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="/assets/media/post_images/java-apt.jpg" alt="Summary Image"></td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="http://www.informit.com/articles/article.aspx?p=2027052&amp;seqNum=6">http://www.informit.com/articles/article.aspx?p=2027052&amp;seqNum=6</a></td>
    </tr>
  </tbody>
</table>

<p>APT 는 컴파일 시점에 Java 코드 내의 Annotation 을 감지해서 Annotation 이 설정되어 있는 코드들은 새로운 Java 코드를 생성한 뒤 컴파일하도록 합니다.</p>

<p>Compile 단계가 더 추가되었지만 Runtime 시에는 성능상으로 영향이 거의 없다는 장점이 있습니다.</p>

<p><br></p>

<ul>
  <li>java.lang.reflection? Annotation Processing Tool?</li>
</ul>

<p>Replection 을 활용한 방법은 APT 에 대한 학습에 비하면 다소 쉬운면이 있습니다. 하지만 Runtime 시에 annotation 분석을 하기 때문에 성능상 이슈가 있습니다. 반면 APT 를 활용한 방식은 컴파일시 시간적인 비용과 APT 를 통해 생성된 코드는 A.java -&gt; A_.java 와 같은 형태로 변한다는 단점이 있으나 Runtime 시 성능상 이점이 있습니다.</p>

<h3 id="android-와-annotation">Android 와 Annotation</h3>

<p>안드로이드에서는 기본적으로 Java 1.6 에서 사용되는 Annotation 들을 지원합니다.
대표적으로 <a href="https://github.com/Override" class="user-mention">@Override</a> 입니다.</p>

<p>그외 에도 안드로이드 특성에 맞게 android.annotation 이 있으며
android.support.annotation 을 사용하면 Compile 시의 타겟에 대한 Validation을 미리 설정할수 있도록 도와줍니다.</p>

<p>그외에도 AndroidAnnotations, ButterKnife, Dagger 등이 APT 를 이용하여 안드로이드를 지원하고 있으며 안드로이드용 ORM 라이브러리는 java.lang.reflection 을 이용하여 동작합니다.</p>

<h3 id="참고-블로그">참고 블로그</h3>

<p><a href="http://www.informit.com/articles/article.aspx?p=2027052&amp;seqNum=6">Scripting, Compiling, and Annotation Processing in Java By Cay S. Horstmann and Gary Cornell (http://www.informit.com/articles/article.aspx?p=2027052&amp;seqNum=6)</a></p>

  </div>
</article>


  <article>
  <h2>
    <a href="/news/2015/03/01/01.Android-mvc-mvvm-mvp/">
      Android 와 개발 패턴
    </a>
  </h2>
  <span class="post-category">
    <span class="label">
      android
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Mar 2015
    </span>
    
    <a href="https://github.com/steve" class="post-author">
      <img class="avatar avatar-small" alt="steve" width="24" height="24" data-proofer-ignore="true" src="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24" srcset="https://avatars3.githubusercontent.com/steve?v=3&amp;s=24 1x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=48 2x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=72 3x, https://avatars3.githubusercontent.com/steve?v=3&amp;s=96 4x">
      steve
    </a>
  </div>
  <div class="post-content">
    <p><img src="/img/GitHub-Mark-Light-24px.png" alt="Github"> source: <a href="https://tosslab.github.io/" target="_blank">https://tosslab.github.io</a></p>

<p>이 포스팅은 총 4부로 이어지며 현재는 1부입니다.</p>

<ol>
  <li><a href="/news/2015/03/01/01.Android-mvc-mvvm-mvp">1부 : Android, MVC, MVVM, MVP</a></li>
  <li><a href="/news/2015/03/01/02.android-%EC%99%80-annotation">2부 : Android 와 Annotation</a></li>
  <li><a href="/news/2015/03/01/03.androidannotation-%EA%B3%BC-mvc">3부 : AndroidAnnotations 과 MVC</a></li>
  <li><a href="/news/2015/03/01/04.androidannotation-%EA%B3%BC-%ED%85%8C%EC%8A%A4%ED%8A%B8">4부 : AndroidAnnotations 과 테스트</a></li>
</ol>

<p>코드를 작성해 가는데 있어서 많은 개발자들은 일관성을 유지하고 유지보수성을 높일 수 있는 많은 개발 모델들을 생각해 왔습니다. 특히나 협업하는 과정에서 로직과 View 를 다루는 코드가 뒤섞이게 되면 작성자뿐만 아니라 동료들조차도 유지보수 하기 힘들어지는 모습을 쉽게 볼 수 있습니다.</p>

<p>이러한 코드 작성때문에 팀단위로, 프로젝트 단위로, 때로는 회사 단위로 여러가지 정책을 가지고 코드와 개발 모델들을 일관되게 하려고 많은 노력을 합니다. 이러한 노력에 개발자들 사이에서 많이 통용되는 개발 패턴들이 나오게 되었습니다.</p>

<p>대표적으로 MVC 모델이라고 할 수 있습니다.
필자가 과거에 했던 웹 프로젝트 중 SpringMVC 프레임워크는 외부로부터의 요청을 처리하는 Controller, 실질적인 비지니스 로직을 수행하는 Model, 그리고 화면 처리를 담당하는 View 를 구분할 수 있도록 지원되어 많은 개발자들에게 사랑받고 있는 프레임워크 중 하나입니다.</p>

<p>차츰 View 자체에서 처리해야하는 로직이 복잡해짐에 따라 MVVM과 MVP 패턴이 나오면서 View 내에서도 Logic과 Presenter 를 구분하려는 노력이 끊임없이 나왔습니다.</p>

<p>이외에도 많은 개발 패턴들이 있지만 가장 많이 통용되는 이야기를 하고자 합니다.</p>

<h3 id="초창기-안드로이드-개발-코드의-모습">초창기 안드로이드 개발 코드의 모습</h3>

<p>안드로이드에서도 초창기 부터 이러한 노력이 끊임없이 나왔습니다.
MVC 와 같은 개발 패턴에 익숙해져 있던 많은 개발자들은 안드로이드에도 이와 같은 모습을 적용하려고 노력하였습니다.</p>

<p>다음 코드는 일반적으로 처음 안드로이드를 접하는 사람들이 쓰는 코드들입니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainAcivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">saveInstance</span><span class="o">)</span> <span class="o">{</span>
	   <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">saveInstance</span><span class="o">);</span>
	   <span class="n">setContent</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">main</span><span class="o">);</span>

	   <span class="n">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_confirm</span><span class="o">);</span>
	   <span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Non-Clicked"</span><span class="o">);</span>


	   <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_confirm</span><span class="o">).</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>

	       <span class="nd">@Override</span>
	       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
	           <span class="n">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_confirm</span><span class="o">);</span>
	           <span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">getClickedText</span><span class="o">());</span>
	       <span class="o">}</span>
	   <span class="o">});</span>
	<span class="o">}</span>

	<span class="n">String</span> <span class="nf">getClickedText</span><span class="o">()</span> <span class="o">{</span>
	   <span class="k">return</span> <span class="s">"Clicked!!!"</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>Activity 내에 이벤트를 핸들링하는 처리나 뷰에 접근하는 코드들이 모두 있습니다.</p>

<p>이러한 코드들의 모습은 서버기반 동작시엔 하나의 Activity 내에 네트워크 처리를 위한 쓰레드 처리까지 하게되는 등 코드가 커지면 커질수록 가독성도 떨어지며 유지보수가 힘들어지는 코드로 가기 쉬워집니다.</p>

<p>그래서 기존의 웹에서처럼 좀 더 기능별로 분할하여 코드들을 간결하고 유지보수가 쉬워지도록 하기 위한 방법들이 많이 도입되기 시작하였습니다.</p>

<h3 id="나은-코드들을-위한-패턴들">나은 코드들을 위한 패턴들</h3>

<p>하지만 화면이 점점 복잡해지게 되고 점점 View 에 의해 제어되는 로직들이 많아짐에 따라 이를 분리하고하는 노력들이 나왔습니다.</p>

<p>다음은 웹 서비스 개발자들에게 가장 쉽게 사용되었던 MVC 패턴을 적용한 코드입니다.</p>

<ul>
  <li>MVC</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainAcivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">MainModel</span> <span class="n">mainModel</span><span class="o">;</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">saveInstance</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">saveInstance</span><span class="o">);</span>
		<span class="n">setContent</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">main</span><span class="o">);</span>
		
		<span class="n">mainModel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainModel</span><span class="o">();</span>
		
		<span class="n">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_confirm</span><span class="o">);</span>
		<span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Non-Clicked"</span><span class="o">);</span>
		
		
		<span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_confirm</span><span class="o">)</span>
			<span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">(){</span>
			
				<span class="nd">@Override</span>
				<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">mainModel</span><span class="o">.</span><span class="na">getClickedText</span><span class="o">();</span>
					<span class="n">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_confirm</span><span class="o">);</span>
					<span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">mainModel</span><span class="o">.</span><span class="na">getClickedText</span><span class="o">());</span>
				<span class="o">}</span>
			<span class="o">});</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainModel</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getClickedText</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">"Clicked!!!"</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>View 에 상관없는 로직을 MainModel 로 분리를 하였기 때문에 Activity 는 View 와 Click Event 를 처리하는 모습으로 변화되었습니다.</p>

<p>하지만 Click Event 와 View 에 대한 처리가 함께 있는 것을 유심히 생각해볼 필요가 있습니다.
MVC 모델에서 Controller 는 View 에 대한 처리를 직접 하는 것이 아니라 View 에 대한 정보만을 View 에 전달함으로써 화면을 그리는 View 와 동작을 처리하는 로직을 분리하고자 하는데서 시작되었습니다.</p>

<p>헌데 Controller 의 역할을 수행하는 Activity 에서 View 에 대한 직접적인 조작을 수행하는 것은 MVC 모델에 어긋나는 모습을 보여주게 됩니다.</p>

<p>이는 Android 에서 Activity(Fragment) 가 View 와 Controller 두가지의 특성을 모두 가지고 있기 때문에 View 나 Controller 를 한쪽으로 빼게 될 경우 View 에 대한 바인딩이나 처리에서 중복 코드나 일관성을 잃어버리는 코드를 작성할 수 있기 때문입니다.
이를 개선하기 위해서 MVVM 이란 패턴을 적용해봤습니다.</p>

<ul>
  <li>MVVM</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainAcivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">MainViewModel</span> <span class="n">mainViewModel</span><span class="o">;</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">saveInstance</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">saveInstance</span><span class="o">);</span>
		<span class="n">setContent</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">main</span><span class="o">);</span>
		
		<span class="n">mainViewModel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainViewModel</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
		
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainModel</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getClickedText</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">"Clicked!!!"</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainViewModel</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">Activity</span> <span class="n">activity</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">MainModel</span> <span class="n">mainModel</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">TextView</span> <span class="n">textView</span><span class="o">;</span>
	
	<span class="kd">public</span> <span class="nf">MainViewModel</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">activity</span> <span class="o">=</span> <span class="n">activity</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">mainModel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainModel</span><span class="o">();</span>
		<span class="n">initView</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">initView</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
	
		<span class="n">textView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">activity</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_confirm</span><span class="o">);</span>
		<span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Non-Clicked"</span><span class="o">);</span>
	
		<span class="n">activity</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_confirm</span><span class="o">)</span>
			<span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">(){</span>
			
				<span class="nd">@Override</span>
				<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">mainModel</span><span class="o">.</span><span class="na">getClickedText</span><span class="o">();</span>
					<span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">});</span>
	<span class="o">}</span>
	
<span class="o">}</span></code></pre></figure>

<p>ViewModel 로 View 에 대한 처리가 분리되었음을 볼 수 있습니다.</p>

<p>하지만 안드로이드에서 MVVM이 가지는 문제점은 View 에 대한 처리가 복잡해질수록 ViewModel 에 거대해지게 되고 상대적으로 Activity 는 아무런 역할도 하지 않는 형태의 클래스로 변모하게 됩니다.</p>

<p>Controller 의 성격을 지닌 Activity 가 실질적으로 아무런 역할을 하지 못하고 ViewModel 에 치중된 모습을 보여줌으로써 다른 형태의 Activity 클래스를 구현한 꼴이 되어버리는 것입니다.</p>

<p>MainViewModel 에 있는 로직을 다시 Activity 로 롤백한다하면 다시 MVC 가 가지고 있는 문제점을 가지게 되는 아이러니한 모습을 가지게 됩니다.</p>

<p>다음은 이러한 View - Model - Controller 의 모습을 명확히 구분하고자 나온 MVP 모델을 보도록 하겠습니다.</p>

<ul>
  <li>MVP</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MainPresenter</span> <span class="o">{</span>

	<span class="kt">void</span> <span class="nf">setView</span><span class="o">(</span><span class="n">MainPresenter</span><span class="o">.</span><span class="na">View</span> <span class="n">view</span><span class="o">);</span>

	<span class="kt">void</span> <span class="nf">onConfirm</span><span class="o">();</span>

	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">View</span> <span class="o">{</span>
		<span class="kt">void</span> <span class="nf">setConfirmText</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">);</span>
	<span class="o">}</span>
	
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainAcivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="kd">implements</span> <span class="n">MainPresenter</span><span class="o">.</span><span class="na">View</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">MainPresenter</span> <span class="n">mainPresenter</span><span class="o">;</span>
	
	<span class="kd">private</span> <span class="n">Button</span> <span class="n">confirmButton</span><span class="o">;</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">saveInstance</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">saveInstance</span><span class="o">);</span>
		<span class="n">setContent</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">main</span><span class="o">);</span>
		
		<span class="n">mainPresenter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainPresenterImpl</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
		<span class="n">mainPresenter</span><span class="o">.</span><span class="na">setView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
		
		<span class="n">confirmButton</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btn_confirm</span><span class="o">);</span>
		<span class="n">confirmButton</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClick</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">mainPresenter</span><span class="o">.</span><span class="na">onConfirm</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">});</span>
	<span class="o">}</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setButtonText</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">confirmButton</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainModel</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getClickedText</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">"Clicked!!!"</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainPresenterImpl</span> <span class="kd">implements</span> <span class="n">MainPresenter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Activity</span> <span class="n">activity</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">MainPresenter</span><span class="o">.</span><span class="na">View</span> <span class="n">view</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MainPresenterImpl</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">activity</span> <span class="o">=</span> <span class="n">activity</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mainModel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainModel</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setView</span><span class="o">(</span><span class="n">MainPresenter</span><span class="o">.</span><span class="na">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
    	<span class="k">this</span><span class="o">.</span><span class="na">view</span> <span class="o">=</span> <span class="n">view</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConfirm</span><span class="o">()</span> <span class="o">{</span>
    	<span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    		<span class="n">view</span><span class="o">.</span><span class="na">setConfirmText</span><span class="o">(</span><span class="n">mainModel</span><span class="o">.</span><span class="na">getClickedText</span><span class="o">());</span>
    	<span class="o">}</span>
    <span class="o">}</span>
    

<span class="o">}</span></code></pre></figure>

<p>MVP 모델의 구분은 다음과 같다.</p>

<ol>
  <li>View 는 실제 view 에 대한 직접적인 접근을 담당한다.</li>
  <li>view 에서 발생하는 이벤트는 직접 핸들링하나 Presenter 에 위임하도록 한다.</li>
  <li>Presenter 는 실질적인 기능을 제어하는 곳으로써 ViewController 로써 이해하면 쉽다.</li>
  <li>Model 은 비지니스 로직을 실질적으로 수행한다.</li>
</ol>

<p>Presenter : View 는 1:1 로 매칭하며 View Presenter 가 주요 기능을 관장하되 실제 view 에서 발생하는 이벤트는 Presenter (이벤트 : View -&gt; Presenter) 로 전달하여 처리하도록 하고 다시 처리된 결과는 Presenter 가 View 에 전달하도록 하여 처리한다. (처리 결과 표현 : Presenter -&gt; View)</p>

<h3 id="정리">정리</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center"> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="/assets/media/post_images/mvc-mvp-mvvm.png" alt="Summary Image" style="background-color:white;padding: 5px;"></td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://tomyrhymond.wordpress.com/2011/09/16/mvc-mvp-and-mvvm/">https://tomyrhymond.wordpress.com/2011/09/16/mvc-mvp-and-mvvm/</a></td>
    </tr>
  </tbody>
</table>

<ul>
  <li>MVC</li>
</ul>

<p>외부의 모든 이벤트를 Controller(Activity) 에서 처리하되
View 에 관여는 하지 않는 것이 원칙입니다.
하지만 Activity 의 특성상 View 관여하지 않을 수 없습니다. 결국 Android 에서는 MVC 의 구조를 계속적으로 유지하기에는 무리가 있습니다.</p>

<ul>
  <li>MVVM</li>
</ul>

<p>ViewModel 이 뷰와의 상호작용 및 제어에 집중합니다. 
ViewModel 에서 직접 뷰의 이벤트를 처리하기 때문에 Controller 의 역할도 함께 수행하게 되어 점점 코드가 집중 되는 구조가 될 수 있습니다. 또한 초기화와 외부 이벤트(뷰에 의한 것이 아닌 이벤트)를 제외 하고는 Activity 의 역할이 모호해지게 됩니다.</p>

<ul>
  <li>MVP</li>
</ul>

<p>View 에 대한 직접적인 접근이 요구되는 Android 의 Activity 는 직접적인 view 접근은 Activity 가 하도록 하고 이에 대한 제어는 Presenter 가 하도록 하고 있다.</p>

<p><br>
어느 것이 낫다라고 말하기에는 어려운 단계입니다. 하지만 많은 개발자들이 안드로이드에서는 MVC 자체의 모습보다는 MVVM 이나 MVP 가 가장 적합하다는 말을 많이 하고 있습니다.
이는 Activity 가 View 를 포함한 클래스이기 때문에 나타나는 현상이라고 볼 수 있습니다.</p>

<p>다음 포스팅에는 이를 해결하기 위해 저희가 사용한 AndroidAnnotations 에 대해 알려드리도록 하겠습니다.</p>

<h3 id="참고-블로그">참고 블로그</h3>

<p><a href="http://atconsole.com/2013/06/05/mvc-mvp-mvvm-%EC%9D%98-%EC%9D%B4%ED%95%B4/">MVC, MVP, MVVM 의 이해 - 이항희(http://atconsole.com/2013/06/05/mvc-mvp-mvvm-%EC%9D%98-%EC%9D%B4%ED%95%B4/)</a></p>

<p><a href="https://tomyrhymond.wordpress.com/2011/09/16/mvc-mvp-and-mvvm/">MVC, MVP AND MVVM - tomyrhymond(https://tomyrhymond.wordpress.com/2011/09/16/mvc-mvp-and-mvvm/)</a></p>


  </div>
</article>



      </div>

      <div class="unit one-fifth hide-on-mobiles">
  <aside>
    <ul>
      <li class="">
        <a href="/news/">All Post</a>
      </li>
      <li class="">
        <a href="/news/releases/">Kotlin Releases</a>
      </li>
    </ul>
    <h4>Recent Releases</h4>
    <ul>
      
    </ul>
    <h4>Other Posts</h4>
    <ul>
        
        
        <li class="">
          <a href="/news/2018/05/13/android-01/">Kotlin Programming Language</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2016/12/03/gradle-tip/">Android Gradle Tips</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2016/07/26/android-database-tip/">Android 의 Sqlite Tip</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2016/04/16/migration-to-retrofit2/">Retrofit2 로 전환</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2016/02/12/Android-and-automation/">안드로이드와 자동화 툴</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/11/26/%EB%8D%94-%EB%B9%A0%EB%A5%B8-Andriod-App-Build/">더 빠른 Android App Build</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/03/10/.androidannotations-%EC%99%80-MVP/">AndroidAnnotations 와 MVP</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/03/01/04.androidannotation-%EA%B3%BC-%ED%85%8C%EC%8A%A4%ED%8A%B8/">AndroidAnnotations 과 테스트</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/03/01/03.androidannotation-%EA%B3%BC-mvc/">AndroidAnnotations 과 MVC 패턴</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/03/01/02.android-%EC%99%80-annotation/">Android 와 Annotation</a>
        </li>
        
        
        
        <li class="">
          <a href="/news/2015/03/01/01.Android-mvc-mvvm-mvp/">Android 와 개발 패턴</a>
        </li>
        
        
    </ul>
  </aside>
</div>


      <div class="clear"></div>

    </div>
  </section>


  <footer>
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <p>
        © 2018 Laon Dreams
      <br>Contacts: <a href="mailto:laondreams@gmail.com">laondreams@gmail.com</a></p>
    </div>
    <div class="unit two-thirds align-right center-on-mobiles">
      <p>
        Proudly hosted by
        <a href="https://github.com">
          <img src="/img/footer-logo.png" width="100" height="30" alt="GitHub • Social coding">
        </a>
      </p>
    </div>
  </div>
</footer>

  <script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = "#" + id;
    anchor.innerHTML = "<span class=\"sr-only\">Permalink</span><i class=\"fa fa-link\"></i>";
    anchor.title = "Permalink";
    return anchor;
  };

  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];

      if (typeof header.id !== "undefined" && header.id !== "") {
        header.appendChild(anchorForId(header.id));
      }
    }
  };

  document.onreadystatechange = function () {
    if (this.readyState === "complete") {
      var contentBlock = document.getElementsByClassName("docs")[0] || document.getElementsByClassName("news")[0];
      if (!contentBlock) {
        return;
      }
      for (var level = 1; level <= 6; level++) {
        linkifyAnchors(level, contentBlock);
      }
    }
  };
</script>

  
  <!-- Google Analytics (https://www.google.com/analytics) -->
  <script>
    !function(j,e,k,y,l,L){j.GoogleAnalyticsObject=y,j[y]||(j[y]=function(){
    (j[y].q=j[y].q||[]).push(arguments)}),j[y].l=+new Date,l=e.createElement(k),
    L=e.getElementsByTagName(k)[0],l.src='https://www.google-analytics.com/analytics.js',
    L.parentNode.insertBefore(l,L)}(window,document,'script','ga');

    ga('create', 'UA-119113988-1', 'auto');
    ga('send', 'pageview');

  </script>


  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
apiKey: '50fe39c839958dfad797000f33e2ec17',
indexName: 'jekyllrb',
inputSelector: '#docsearch-input',
enhancedSearchInput: true,
debug: false // Set debug to true if you want to inspect the dropdown
});
</script>

</body>
</html>
